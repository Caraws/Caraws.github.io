<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Author Name,name@example.com"><title>Algebraic Effects & React Â· Cara's Blog</title><meta name="description" content="å‰è¨€è¿™å‡ å¹´ç½‘ä¸Šå·²ç»æœ‰éå¸¸çš„å¤šæ–‡ç« åœ¨æ¢è®¨ React è¿™æ¬¡çš„å¤§æ‰‹ç¬”, æ­£å¥½å€Ÿåœ¨ Bench è¿™æ®µæ—¶é—´é‡Œèƒ½é€šè¿‡ React18 çš„æºç çœ‹çœ‹åˆ°åº•åšäº†å“ªäº›æ”¹å˜, ä¸»è¦æ˜¯å¯¹æ—¶é—´åˆ‡ç‰‡å’Œè°ƒåº¦æ–¹é¢æ¯”è¾ƒæ„Ÿå…´è¶£
æ¥ç€å°±git clone -&amp;gt; setup æºç  -&amp;gt; æ·»åŠ beakPoint ä¸€é¡¿æ“ä½œçŒ›å¦‚è™,"><meta name="keywords" content="Hexo,HTML,CSS,android,Linux"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/avator.jpg" style="width:127px;"><h3 title=""><a href="/">Cara's Blog</a></h3><div class="description"><p>å’¸é±¼çš„å­¦ä¹ ğŸ“’ Lok'tar</p></div></div></div><ul class="social-links"><li><a href="/atom.xml"><i class="fa fa-rss"></i></a></li><li><a href="http://github.com/Caraws"><i class="fa fa-github"></i></a></li></ul><div class="footer"></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">é¦–é¡µ</a></li><li><a href="/archives">å½’æ¡£</a></li><li><a href="/about">å…³äº</a></li><li><a href="/links">å‹é“¾</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="/images/favicon.jpeg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Algebraic Effects &amp; React</a></h3></div><div class="post-content"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™å‡ å¹´ç½‘ä¸Šå·²ç»æœ‰éå¸¸çš„å¤šæ–‡ç« åœ¨æ¢è®¨ React è¿™æ¬¡çš„å¤§æ‰‹ç¬”, æ­£å¥½å€Ÿåœ¨ Bench è¿™æ®µæ—¶é—´é‡Œèƒ½é€šè¿‡ React18 çš„æºç çœ‹çœ‹åˆ°åº•åšäº†å“ªäº›æ”¹å˜, ä¸»è¦æ˜¯å¯¹æ—¶é—´åˆ‡ç‰‡å’Œè°ƒåº¦æ–¹é¢æ¯”è¾ƒæ„Ÿå…´è¶£</p>
<p>æ¥ç€å°±<code>git clone</code> -&gt; <code>setup æºç </code> -&gt; <code>æ·»åŠ beakPoint</code> ä¸€é¡¿æ“ä½œçŒ›å¦‚è™, ç„¶åå‘ç° emmmâ€¦ æ ¹æœ¬æ— ä»ä¸‹æ‰‹â€¦ </p>
<p>React çš„ä»£ç é‡æ—¢å¤š, è·³è½¬é€»è¾‘åˆå¾ˆå¤æ‚. æ‰€ä»¥æœæ–­æ¢æ€è·¯ä»è®¾è®¡æ€æƒ³å‡ºå‘, å†åˆ°å®ç°. èµ·ç ä½ å…ˆçŸ¥é“ React_ _æƒ³åšä»€ä¹ˆ, åœ¨çœ‹å’‹å®ç°çš„ä¸å®¹æ˜“å¤šäº†å—(æ˜¯å—?ğŸ˜’)</p>
<p>äºæ˜¯æ‰“å¼€æµè§ˆå™¨ Google: React çš„è®¾è®¡æ€æƒ³, ç¬¬ä¸€ä¸ªè¹¦å‡ºæ¥çš„å°±æ˜¯ä»Šå¤©çš„ä¸»è§’: <strong>ä»£æ•°æ•ˆåº”</strong><br>å¬ä¸Šå»æ˜¯ä¸ªå¾ˆå¯æ€•çš„åå­—â€¦</p>
<blockquote>
<p>å¼•ç”¨ä¸€ä½ React çš„æ ¸å¿ƒå¼€å‘è€… <a href="https://github.com/sebmarkbage/" target="_blank" rel="noopener">Sebastian MarkbÃ¥ge</a> çš„è¯<br>React æ‰€åšçš„äº‹å°±æ˜¯åœ¨è·µè¡Œä»£æ•°æ•ˆåº”</p>
</blockquote>
<p>ä¸ºäº†æ›´å¥½å¾—ç†è§£ä»£æ•°æ•ˆåº”, æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¸ä¹‹ç›¸å…³çš„ä¸€ä¸ªä¸œè¥¿: CPS </p>
<h2 id="Continuation-Passing-Style-CPS"><a href="#Continuation-Passing-Style-CPS" class="headerlink" title="Continuation Passing Style (CPS)"></a>Continuation Passing Style (CPS)</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> add = <span class="function">(<span class="params">x, y</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> x + y</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> subtract = <span class="function">(<span class="params">x, y</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> y - x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> multiply = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> a * b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result1 = add(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="keyword">const</span> result2 = subtract(result1, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">const</span> result3 = multiply(result2, <span class="number">3</span>)</span><br><span class="line"><span class="built_in">console</span>.log(result3) <span class="comment">// 6</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> add = <span class="function">(<span class="params">x, y, next</span>) =&gt;</span> &#123;</span><br><span class="line">  next(x + y)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> subtract = <span class="function">(<span class="params">x, y, next</span>) =&gt;</span> &#123;</span><br><span class="line">  next(y - x)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> multiply = <span class="function">(<span class="params">a, b, next</span>) =&gt;</span> &#123;</span><br><span class="line">  next(a * b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>, <span class="number">2</span>, (result1) =&gt; &#123;</span><br><span class="line">  subtract(result1, <span class="number">1</span>, (result2) =&gt; &#123;</span><br><span class="line">    multiply(result2, <span class="number">3</span>, <span class="built_in">console</span>.log) <span class="comment">// 6</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>å¯¹æ¯”ä¹‹ä¸‹, æˆ‘ä»¬å¯ä»¥å‘ç°: å¥½å®¶ä¼™! CPS ä¸å°±æ˜¯æˆ‘ä»¬å—¤ä¹‹ä»¥é¼»çš„å›è°ƒåœ°ç‹±å—! è€Œä¸”å¯è¯»æ€§å¥‡å·®<br>æ—¢ç„¶è¿™æ ·é‚£æˆ‘ä»¬ä¸ºä»€ä¹ˆè¿˜è¦å†™ CPS å‘¢? ç­”æ¡ˆæ˜¯: ä¸ç”¨å†™, ä½†æ˜¯å¹¶ä¸ä»£è¡¨ CPS å°±æ˜¯ä¸€æ— æ˜¯å¤„çš„. </p>
<h3 id="æŠ›å¼ƒåˆšåˆšå¯¹-CPS-çš„æœ‰è‰²çœ¼é•œ-é‡æ–°è§‚å¯Ÿåˆ†æä¸€ä¸‹-CPS-åˆ°åº•æœ‰ä»€ä¹ˆä¼˜åŠ¿"><a href="#æŠ›å¼ƒåˆšåˆšå¯¹-CPS-çš„æœ‰è‰²çœ¼é•œ-é‡æ–°è§‚å¯Ÿåˆ†æä¸€ä¸‹-CPS-åˆ°åº•æœ‰ä»€ä¹ˆä¼˜åŠ¿" class="headerlink" title="æŠ›å¼ƒåˆšåˆšå¯¹ CPS çš„æœ‰è‰²çœ¼é•œ, é‡æ–°è§‚å¯Ÿåˆ†æä¸€ä¸‹ CPS åˆ°åº•æœ‰ä»€ä¹ˆä¼˜åŠ¿"></a>æŠ›å¼ƒåˆšåˆšå¯¹ CPS çš„æœ‰è‰²çœ¼é•œ, é‡æ–°è§‚å¯Ÿåˆ†æä¸€ä¸‹ CPS åˆ°åº•æœ‰ä»€ä¹ˆä¼˜åŠ¿</h3><h4 id="1-Continuation"><a href="#1-Continuation" class="headerlink" title="1. Continuation"></a>1. Continuation</h4><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­, æ¯ä¸ªå‡½æ•°éƒ½æ¥æ”¶ä¸€ä¸ª<code>next</code>å›è°ƒå‡½æ•°, è€Œä¸”æ¯ä¸ªå‡½æ•°çš„è®¡ç®—ç»“æœéƒ½æ˜¯é€šè¿‡<code>next</code><strong>å»¶ç»­</strong>(ç»†å“å»¶ç»­è¿™ä¸ªè¯)ç»™ä¸‹ä¸€ä¸ªå‡½æ•°.<br>é¡ºç€è¿™ä¸ªæ€è·¯å†æ¥çœ‹ä¸ CPS å¯¹æ¯”çš„ Direct Style, å®ƒå¯¹æµç¨‹çš„æ§åˆ¶å®Œå…¨å–å†³äºæˆ‘ä»¬è°ƒç”¨å•¥. æ‰€ä»¥å®ƒå¯¹å»¶ç»­æ€§(continuation)çš„æ§åˆ¶æ˜¯éšå¼çš„, ä¸åƒ CPS æˆ‘ä»¬ä¸€çœ‹åˆ°<code>next</code>å°±çŸ¥é“è¿™æ˜¯è¦æ§åˆ¶æµç¨‹ç»§ç»­å¾€ä¸‹å»¶ç»­äº†. <br>æ¢å¥è¯è¯´ CPS èƒ½æ§åˆ¶ç¨‹åºåç»­çš„æµç¨‹</p>
<h4 id="2-åŒæ—¶å…¼å®¹åŒæ­¥å’Œå¼‚æ­¥å¤„ç†"><a href="#2-åŒæ—¶å…¼å®¹åŒæ­¥å’Œå¼‚æ­¥å¤„ç†" class="headerlink" title="2. åŒæ—¶å…¼å®¹åŒæ­¥å’Œå¼‚æ­¥å¤„ç†"></a>2. åŒæ—¶å…¼å®¹åŒæ­¥å’Œå¼‚æ­¥å¤„ç†</h4><p>è¿˜æ˜¯åˆ©ç”¨ä¸Šé¢çš„ä¾‹å­, å‡å¦‚ç°åœ¨æ–°å¢ä¸€ä¸ªéœ€æ±‚ add åéœ€è¦ç­‰å¾… 2 ç§’å†æ‰§è¡Œ, å¯¹äº Direct Style æˆ‘ä»¬å¿…é¡»å¯¹ add åç»­çš„æ•´ä¸ªæµç¨‹è¿›è¡Œè°ƒæ•´<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> add = <span class="function">(<span class="params">x, y</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> x + y</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> subtract = <span class="function">(<span class="params">x, y</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> y - x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> multiply = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> a * b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result1 = add(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> result2 = subtract(result1, <span class="number">1</span>)</span><br><span class="line">  <span class="keyword">const</span> result3 = multiply(result2, <span class="number">3</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(result3) <span class="comment">// 6</span></span><br><span class="line">&#125;, <span class="number">2000</span>)</span><br></pre></td></tr></table></figure></p>
<p>å¯¹äº CPS åˆ™åªéœ€è¦æ”¹å˜<code>next</code>çš„è°ƒç”¨æ—¶æœºå³å¯<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> add = <span class="function">(<span class="params">x, y, next</span>) =&gt;</span> &#123;</span><br><span class="line">  next(x + y)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> subtract = <span class="function">(<span class="params">x, y, next</span>) =&gt;</span> &#123;</span><br><span class="line">  setTimeout(next, <span class="number">2000</span>, y - x)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> multiply = <span class="function">(<span class="params">a, b, next</span>) =&gt;</span> &#123;</span><br><span class="line">  next(a * b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>, <span class="number">2</span>, (result1) =&gt; &#123;</span><br><span class="line">  subtract(result1, <span class="number">1</span>, (result2) =&gt; &#123;</span><br><span class="line">    multiply(result2, <span class="number">3</span>, <span class="built_in">console</span>.log) <span class="comment">// 6</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹å‡ºè¿™æ ·çš„æ”¹åŠ¨å¯¹äº CPS æ¥è¯´, å¹¶ä¸éœ€è¦æ”¹åŠ¨åˆ°ä¸»æµç¨‹.</p>
<h4 id="3-Tail-Call"><a href="#3-Tail-Call" class="headerlink" title="3. Tail Call"></a>3. Tail Call</h4><p>CPS åŒæ—¶ä¹Ÿæ˜¯å°¾è°ƒç”¨, åªä¸è¿‡ JS å¼•æ“å¹¶ä¸æ”¯æŒè¿™ç§ä¼˜åŒ–, åœ¨æ­¤ä¹Ÿä¸å±•å¼€äº†</p>
<p>é‚£ä¹ˆ CPS å¯¹äºæµç¨‹æ§åˆ¶æœ‰è¿™ä¹ˆå¼ºå¤§çš„åŠ›é‡, ä½†æ˜¯åˆç¢äºå®ƒåäººç±»çš„ä¹¦å†™æ–¹å¼ä¸èƒ½ä½¿ç”¨. é‚£åœ¨ JS ä¸­æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•èƒ½è§£å†³è¿™ä¸ªä¹¦å†™çš„é—®é¢˜å‘¢?<br><strong>Promise</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> add = <span class="function">(<span class="params">x, y</span>) =&gt;</span> <span class="built_in">Promise</span>.resolve(x + y)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> subtract = <span class="function">(<span class="params">x, y</span>) =&gt;</span> delay(<span class="number">2000</span>).then(<span class="function"><span class="params">()</span> =&gt;</span> y - x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> multiply = <span class="function">(<span class="params">a, b</span>) =&gt;</span> <span class="built_in">Promise</span>.resolve(a * b)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> delay = <span class="function">(<span class="params">milli</span>) =&gt;</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> setTimeout(resolve, milli))</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> subtract(res, <span class="number">1</span>))</span><br><span class="line">  .then(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure></p>
<p>ä¹Ÿè®¸ä½ è¿˜æƒ³åˆ°äº† Generator, æ²¡é”™ Generator / Promise / async/await éƒ½æ˜¯ CPS çš„å˜å½¢. å¦‚æœä½ å†ç•™å¿ƒä¸€ç‚¹å°±ä¼šå‘ç° Promise.resolve / Generator.next å…¶å®éƒ½æ˜¯ CPS ä¸­çš„ next</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ä¸€å¥è¯ CPS å¯¹æµç¨‹æ§åˆ¶éå¸¸ç‰›é€¼, ä¸è®ºæ˜¯åŒæ­¥ä»»åŠ¡è¿˜æ˜¯å¼‚æ­¥ä»»åŠ¡éƒ½æ‹¿æçš„æ­»æ­»çš„</p>
<h2 id="Algebraic-Effect"><a href="#Algebraic-Effect" class="headerlink" title="Algebraic Effect"></a>Algebraic Effect</h2><p>å‰é¢æˆ‘ä»¬ä»‹ç»äº†åœ¨ JS ä¸­åº”ç”¨ CPS çš„å§¿åŠ¿, ä½†å³ä½¿è¿™æ ·, æˆ‘ä»¬åœ¨ JS ä¸­ä½¿ç”¨ CPS ä¾ç„¶å¾ˆç¹ç. </p>
<blockquote>
<p>å¦‚æœä½ ç”¨äº† Promise é‚£ä¹ˆä½ çš„æ§åˆ¶æµéƒ½å¾—æ˜¯ Promise; å¦‚æœç”¨Generator éƒ½è¦åŒ…è£¹åœ¨ Generator ä¸­; async/await ä¹Ÿæ˜¯ä¸€æ ·. å°±åƒå¾ˆå¤šæ–‡ç« ä¸­æåˆ°çš„ä¸€æ ·, è¿™äº›æ–¹å¼éƒ½å…·æœ‰â€ä¼ æŸ“æ€§â€, å®ƒä»¬ä¼šç”±å†…åˆ°å¤–çš„å±‚å±‚æ±¡æŸ“, é‚£ä¹ˆå¿…ç„¶å°±ä¼šç»™å¼€å‘è€…å¸¦æ¥å¤§é‡çš„å¿ƒæ™ºè´Ÿæ‹…</p>
</blockquote>
<p>é‚£æœ‰æ²¡æœ‰æ›´ä¾¿æ·çš„æ–¹å¼æ¥å®ç°å‘¢, æƒ³æƒ³åœ¨JS ç¯å¢ƒä¸‹æœ‰å“ªäº›èƒ½å¤Ÿæ§åˆ¶æµç¨‹çš„æ–¹å¼å‘¢?<br><code>if</code>/<code>else</code>/ <code>break</code>/<code>throw</code>/<code>switch</code>â€¦ å—¯? <code>throw</code>ğŸ¤” å¥½åƒè·Ÿå…¶ä»–æ§åˆ¶æœ‰äº›ä¸ä¸€æ ·, å®ƒå¯ä»¥è·³è¿‡åç»­æµç¨‹(ç©¿é€è°ƒç”¨æ ˆ)! è¿™ä¼¼ä¹æœ‰ç‚¹åŠ å¼º CPS é‚£å‘³å„¿äº†</p>
<p>å›å¿†ä¸€ä¸‹: ä½¿ç”¨ <code>throw</code>æ—¶ä¼šåœ¨è°ƒç”¨å¤„ä¸­æ–­, å°† <code>throw</code>åé¢çš„è¯­å¥ç©¿é€åˆ°æœ€è¿‘çš„ <code>try/catch</code>ä¸­ä»è€Œè¢«æ•è·.</p>
<blockquote>
<p> PS: è™½ç„¶è§„èŒƒå‘Šè¯‰æˆ‘ä»¬ <code>throw</code>å‡ºæ¥çš„å¿…é¡»æ˜¯ä¸ª <code>Error</code>å¯¹è±¡, ä½†å®é™… <code>throw</code>å¯ä»¥æŠ›å‡ºä»»æ„æ•°æ®ç±»å‹</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">taskA</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="string">'throw from taskA'</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'never arrive'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'I am main'</span>)</span><br><span class="line">  taskA()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  main()</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'catch: '</span>,err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¢å¥è¯è¯´, é€šè¿‡<code>throw</code>å°†æ‰§è¡Œæµç¨‹è½¬ç§»è‡³<code>catch</code>ä»£ç å—, è¿™å°±æ˜¯æ‰€è°“çš„<strong> Control Transfer æ§åˆ¶è½¬ç§»</strong></p>
<p>å¦‚æœæˆ‘ä»¬æŠŠä¸¤è€…ç»“åˆä¸€ä¸‹, è¯•æƒ³å°† CPS çš„<code>next</code>é€šè¿‡<code>throw</code>æ“ä½œç¬¦å°†æ§åˆ¶æµè½¬ç§»è‡³ <code>catch</code>ä¸­. è¿™æ ·æ—¢è§£å†³äº† CPS å¯è¯»æ€§çš„é—®é¢˜, åŒæ—¶ä¹Ÿå¯ä»¥é¿å… â€œä¼ æŸ“â€; é™¤æ­¤ä¹‹å¤–, è¿˜éš”ç¦»äº†å‡½æ•°ä¸­çš„å‰¯ä½œç”¨. å®é™…ä¸Šè¿™â€åŸºæœ¬ä¸Šâ€å°±æ˜¯ä»£æ•°æ•ˆåº”æ‰€è•´å«çš„æ€æƒ³äº†<br><br>ä¸ºä»€ä¹ˆè¦è¯´æ˜¯â€åŸºæœ¬ä¸Šå‘¢â€? å› ä¸ºè¿™é‡Œè¿˜æœ‰ä¸ªé—®é¢˜, é‚£å°±æ˜¯åœ¨ JS ä¸­<code>throw</code>åå°±ä¸­æ–­äº†, ä¸èƒ½<strong>å»¶ç»­(æˆ–è€…æ¢å¤)å½“å‰æ§åˆ¶æµ</strong>(ä¹Ÿå°±æ˜¯ CPS ä¸­çš„ Continuation). æ‰€ä»¥å¾ˆå¤šå…¶ä»–æ–‡ç« ä¸­éƒ½å¤©é©¬è¡Œç©ºåœ°é€ äº†ä¸€äº›ç‰¹æ®Šçš„å…³é”®å­—æ¥å°è¯•è§£é‡Šä»£æ•°æ•ˆåº”, è¿™é‡Œæˆ‘ä¹Ÿä½¿ç”¨ <a href="https://overreacted.io/zh-hans/algebraic-effects-for-the-rest-of-us/" target="_blank" rel="noopener">Dan Abramov</a> åœ¨æ–‡ç« çš„ç¤ºä¾‹ç¨ä½œä¿®æ”¹æ¥å®Œæ•´çš„å±•ç¤ºä¸€ä¸‹ç†æƒ³ä¸­çš„ä»£æ•°æ•ˆåº”</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Component</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> friendship = <span class="literal">null</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getName</span>(<span class="params">user</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> name = user.name;</span><br><span class="line">    <span class="keyword">if</span> (name === <span class="literal">null</span>) &#123;</span><br><span class="line">      name = perform <span class="string">'ask_name'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> name;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">makeFriends</span>(<span class="params">user1, user2</span>) </span>&#123;</span><br><span class="line">    user1.friendNames = getName(user2);</span><br><span class="line">    user2.friendNames = getName(user1);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      user1,</span><br><span class="line">      user2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> arya = &#123; <span class="attr">name</span>: <span class="literal">null</span> &#125;;</span><br><span class="line">  <span class="keyword">const</span> gendry = &#123; <span class="attr">name</span>: <span class="string">'Gendry'</span> &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    friendship = makeFriends(arya, gendry);</span><br><span class="line">  &#125; handle (effect) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!user1.friendNames || !user2.friendNames) &#123;</span><br><span class="line">      <span class="keyword">if</span> (effect === <span class="string">'ask_name'</span>) &#123;</span><br><span class="line">        resume <span class="keyword">with</span> <span class="string">'Arya Stark'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="string">`friendship: user1: <span class="subst">$&#123;user1.friendNames&#125;</span>; user2: <span class="subst">$&#123;user2.friendNames&#125;</span>`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ä¼ªé€  <code>perform</code>å…³é”®å­—æ›¿ä»£ <code>throw</code>, ç›¸å½“äº CPS ä¸­ next å˜å½¢(ç±»ä¼¼äº await), è€Œ perform åçš„è¯­å¥å¯ä»¥åƒ<code>throw</code>ä¸€æ ·è¢«æŠ›å‡º</li>
<li><code>handle</code>æ›¿ä»£<code>catch</code>, å½¢å‚<code>effect</code>æ¥æ”¶<code>perform</code>å…³é”®å­—ä¼ é€’çš„å®å‚</li>
<li>ä¼ªé€ çš„<code>resume`</code>with`å…³é”®å­—ç”¨äºæ¢å¤å½“å‰æ§åˆ¶æµ(getName ä¸­ç¬¬ 4 è¡Œ), å¹¶å›ä¼  â€˜Arya Starkâ€™</li>
<li>æ¢å¤åæ§åˆ¶æµä¸­ name çš„å€¼å°±å˜æˆäº† â€˜Arya Starkâ€™</li>
</ul>
<p>æ‰€ä»¥è¿™æ®µè™šæ„çš„ä»£ç è¦è¡¨è¾¾çš„å°±æ˜¯: å¯¹ <code>makeFriends</code>äº§ç”Ÿçš„ Effect, é€šè¿‡ <code>perform</code>ç”±<code>handler</code>å¤„ç†, å†ç”¨<code>resume</code>å°†ç»“æœæ¢å¤åˆ°å‡½æ•°æ‰§è¡Œä¸­, å¾—åˆ°æ–°çš„ç»“æœ.</p>
<blockquote>
<p>ä¹‹æ‰€ä»¥è¦æŠŠ CPS çš„ next ç§°ä½œ Continuation, æ˜¯å¸Œæœ›é€šè¿‡ throw å¯ä»¥ç©¿é€è°ƒç”¨æ ˆçš„ç‰¹ç‚¹æ¥è·å–å½“å‰æ§åˆ¶æµ, æ‰€ä»¥ç©¿é€è°ƒç”¨æ ˆ(æˆ–è€…è¯´è·¨è°ƒç”¨æ ˆ)å¹¶ä¸æ˜¯ç›®çš„. è€Œè¦åœ¨ JS ä¸­çœŸæ­£å®ç°è·å–<strong>å½“å‰ Continuation </strong>ä¹Ÿå°±æ˜¯æ‰€è°“çš„ <a href="https://en.wikipedia.org/wiki/Call-with-current-continuation" target="_blank" rel="noopener">callcc</a> ä¹Ÿæ˜¯å¯ä»¥çš„, å¤§è‡´æ˜¯ç”¨ CPS + Generator å®ç°çš„, é‚£ä¹ˆå°±ä¸å¾—ä¸æŠŠæ‰€æœ‰ä¸œè¥¿éƒ½å˜æˆ generator äº†,åœ¨è¿™å„¿å°±ä¸å±•å¼€äº†æœ‰å…´è¶£å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« <a href="https://dev.to/yelouafi/algebraic-effects-in-javascript-part-2---capturing-continuations-with-generators-13da" target="_blank" rel="noopener">capturing-continuations-with-generators</a>.</p>
</blockquote>
<h3 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ä»£æ•°æ•ˆåº”å°±æ˜¯: åˆ©ç”¨ CPS çš„<strong>æµç¨‹æ§åˆ¶</strong>èƒ½åŠ›å®ç°å¯¹åç»­æµç¨‹çš„æ§åˆ¶(perform + resume)ç»“åˆæ§åˆ¶è½¬ç§»èƒ½åŠ›å®ç°è·¨è°ƒç”¨æ ˆæ•è·<strong>å½“å‰æ§åˆ¶æµ</strong>(try/handle), æ”¹å˜å½“å‰æ§åˆ¶æµä¸­çš„ Effect</p>
<p>åœ¨æç‚¼ä¸€ä¸‹ä»£æ•°æ•ˆåº”çš„å…³é”®ç‚¹:</p>
<ul>
<li>Effect: ä»£æ•°æ‰€äº§ç”Ÿçš„çš„æ•ˆåº”</li>
<li>Handler: å¤„ç†æ•ˆåº”çš„é€»è¾‘</li>
<li>Continuation: å»¶ç»­æµç¨‹çš„æ§åˆ¶</li>
<li>Resume: æ¢å¤ + ä¸ä¹‹å¯¹åº”çš„æš‚åœ</li>
</ul>
<h2 id="React-amp-Algebraic-Effect"><a href="#React-amp-Algebraic-Effect" class="headerlink" title="React &amp; Algebraic Effect"></a>React &amp; Algebraic Effect</h2><p>å‰é¢é“ºå«äº†é‚£ä¹ˆå¤šä»£æ•°æ•ˆåº”çš„çŸ¥è¯†, ç°åœ¨æˆ‘ä»¬å°±è¯•ç€çœ‹çœ‹ä»£æ•°æ•ˆåº”åœ¨ React ä¸­æ˜¯å¦‚ä½•åº”ç”¨çš„</p>
<h3 id="Hooks"><a href="#Hooks" class="headerlink" title="Hooks"></a>Hooks</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Component</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [friendship, makeFriends] = useState(&#123;</span><br><span class="line">    arya: &#123; <span class="attr">name</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">    gendry: &#123; <span class="attr">name</span>: <span class="string">'Gendry'</span> &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> arya = friendship.arya</span><br><span class="line">    <span class="keyword">const</span> gendry = friendship.gendry</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!arya.friendNames || !gendry.friendNames) &#123;</span><br><span class="line">      <span class="keyword">const</span> gendryName = getName(gendry)</span><br><span class="line">    	<span class="keyword">const</span> aryaName = getName(arya)</span><br><span class="line">      makeFriends(<span class="function">(<span class="params">preUsers</span>) =&gt;</span> (&#123;</span><br><span class="line">        arya: &#123;</span><br><span class="line">          ...preUsers.arya,</span><br><span class="line">          friendNames: gendryName</span><br><span class="line">        &#125;,</span><br><span class="line">        gendry: &#123;</span><br><span class="line">          ...preUsers.gendry,</span><br><span class="line">          friendNames: aryaName</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [friendship])</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      friendship:</span><br><span class="line">      user1: &#123;friendship.arya.friendNames&#125;</span><br><span class="line">      user2: &#123;friendship.gendry.friendNames&#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åªæ˜¯ä»¥ React çš„æ–¹å¼æ”¹å†™äº†ä¸Šé¢çš„ç¤ºä¾‹, æ¥ç€å†çœ‹çœ‹æ”¹å†™åæ˜¯å¦è¿˜æ»¡è¶³ä»£æ•°æ•ˆåº”çš„å››è¦ç´ .</p>
<ul>
<li>é¦–å…ˆ<code>friendship</code>çš„åˆå§‹å€¼è¢«<code>useState</code>å®šä¹‰, ç„¶åæ ¹æ®<code>getName</code>çš„è¿”å›è€Œè¢«<code>makeFriends</code>ä¿®æ”¹, é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è®¤ä¸º<code>makeFriends</code>æ˜¯<code>friendship</code>äº§ç”Ÿ Effect çš„ä¸€ä¸ªå› ç´ </li>
<li>è€Œæˆ‘ä»¬é€‰æ‹© <code>useEffect</code>å¯¹äº§ç”Ÿçš„æ•ˆåº”è¿›è¡Œå¤„ç†, å¹¶å°†<code>friendship</code>ä½œä¸ºè¯¥ hook çš„ä¾èµ–, å› æ­¤å¯ä»¥è®¤ä¸º <code>useEffect</code>å°±æ˜¯<code>friendship</code>çš„å¤„ç†å™¨äº†</li>
</ul>
<p>æ¥ç€æˆ‘ä»¬è¿˜å¯ä»¥è¿›ä¸€æ­¥çš„å°è£…<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useFriends</span>(<span class="params">defaultValue</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">const</span> [friendship, makeFriends] = useState(defaultValue)</span><br><span class="line">   </span><br><span class="line">   useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">     <span class="built_in">Object</span>.keys()</span><br><span class="line">       .forEach(<span class="function">(<span class="params">key, index, array</span>) =&gt;</span> &#123;</span><br><span class="line">         <span class="keyword">if</span> (!friendship[key].friendNames) &#123;</span><br><span class="line">           <span class="keyword">const</span> name = getName(friendship[key])</span><br><span class="line">           <span class="keyword">const</span> userKey = index % <span class="number">2</span> === <span class="number">0</span> ? array[index + <span class="number">1</span>] : array[index - <span class="number">1</span>]</span><br><span class="line">           </span><br><span class="line">           makeFriends(<span class="function">(<span class="params">preUsers</span>) =&gt;</span> (&#123;</span><br><span class="line">             ...preUsers,</span><br><span class="line">             [userKey]: &#123;...preUsers[name], <span class="attr">friendNames</span>: name&#125;</span><br><span class="line">            &#125;))</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;, [friendship])</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> [friendship]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Component</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [friendship, makeFriends] = useFriends(&#123;</span><br><span class="line">    arya: &#123; <span class="attr">name</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">    gendry: &#123; <span class="attr">name</span>: <span class="string">'Gendry'</span> &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      friendship:</span><br><span class="line">      user1: &#123;friendship.arya.friendNames&#125;</span><br><span class="line">      user2: &#123;friendship.gendry.friendNames&#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>è¿™æ ·ä¸€æ¥æˆ‘ä»¬çš„<code>useFriends</code>ä½œä¸ºä¸€ä¸ªå…·æœ‰ Effect ä»¥åŠå¤„ç†å™¨çš„ä»£æ•°, å°±å¯ä»¥ä¸ºä»»ä½•ç»„ä»¶æœåŠ¡äº†. ä¸è¿‡å¤§å®¶å¯èƒ½æ³¨æ„åˆ°äº†ä»£æ•°æ•ˆåº”æœ€é…·çš„<code>resume</code>ç‰¹æ€§æˆ‘ä»¬å¹¶æ²¡æœ‰çœ‹åˆ°, è¿™è¦å¦‚ä½•ä½¿ç”¨å‘¢?</p>
<h3 id="Fiber"><a href="#Fiber" class="headerlink" title="Fiber"></a>Fiber</h3><p>è¿™å°±å¾—ä» Fiber è¯´èµ·äº†, æˆ‘ä»¬éƒ½çŸ¥é“React ä» v16 å¼€å§‹å°±æ˜¯ Fiber æ¶æ„äº†. è€Œ Fiber æ¶æ„çš„æœ¬è´¨å°±æ˜¯åˆ©ç”¨æµè§ˆå™¨ç©ºé—²æ—¶é—´, æ ¹æ®ä»»åŠ¡çš„ä¼˜å…ˆçº§åˆ†ç‰‡æ‰§è¡Œ, æ›´æ–°è¿‡ç¨‹ä¸­å¯ä»¥éšæ—¶æš‚åœå’Œæ¢å¤ä»»åŠ¡.</p>
<p>ç”¨ä¸‹å›¾æ¥æ¦‚æ‹¬äº†React ä¸­çš„è°ƒåº¦æµç¨‹(æ•´ä¸ªæµç¨‹éƒ½ä»¥å¼€å¯ Concurrent æ¨¡å¼ä¸ºä¾‹)<br><img src="https://cdn.nlark.com/yuque/0/2022/png/25390386/1660553621965-a63963d3-af63-4830-abd8-663160dfe274.png#clientId=uc779f550-7e98-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=1093&amp;id=u9cbef581&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=1093&amp;originWidth=2077&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=194189&amp;status=done&amp;style=none&amp;taskId=u492c6d6d-46b0-4c8d-b05e-d0814a6b938&amp;title=&amp;width=2077" alt="image.png"></p>
<ul>
<li>æ›´æ–°ä»»åŠ¡ä¼šæŒ‰ç…§è¿‡æœŸæ—¶é—´æ’åºæ³¨å†Œåœ¨<code>taskQueue</code>é˜Ÿåˆ—ä¸­(PS:<code>timerQueue</code>ä¿å­˜å»¶æ—¶ä»»åŠ¡, ç­‰æ—¶é—´åˆ°äº†ä¼šæ”¾å…¥<code>taskQueue</code>)</li>
<li>ç„¶åé€šè¿‡<code>performWorkUntilDeadline</code>è°ƒç”¨<code>flushWork</code>æ‰§è¡Œ<code>workLoop</code>æ¥æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡<ul>
<li>æ‰§è¡Œ<code>currentTask.callback</code>(ä¹Ÿå°±æ˜¯ <code>performConcurrentWorkOnRoot</code>), <strong>å¦‚æœæ›´æ–°è¿‡ç¨‹ä¸­ </strong><code>**shouldYield**</code><strong>ä¸º true æš‚åœæ›´æ–°</strong></li>
<li>é‚£ä¹ˆè¿”å›çš„<code>exitState === RootInProgress</code>ä¸ºtrue, å¯¼è‡´<code>currentTask.callback</code><strong>è¿”å› </strong><code>**performConcurrentWorkOnRoot**</code><strong>è‡ªèº«</strong></li>
<li>å†å›åˆ°<code>workLoop</code>æ‹¿åˆ°<code>currentTask.callback</code>çš„æ‰§è¡Œç»“æœ<code>continuationCallback</code>=<code>performConcurrentWorkOnRoot</code>å‡½æ•°, æ‰€ä»¥<code>if (typeof continuationCallback === &#39;function&#39;)</code>æˆç«‹. å³ä¿å­˜<code>continuationCallback</code>åˆ°<code>currentTask.callback</code>,<strong> ä¸ä»</strong><code>**taskQueue**</code><strong>ç§»é™¤å½“å‰ä»»åŠ¡, ä¸‹ä¸ªæ—¶é—´åˆ‡ç‰‡é‡æ–°æ‰§è¡Œ</strong></li>
</ul>
</li>
<li>é‡å¤è¿™ä¸ªè¿‡ç¨‹, ç›´åˆ°é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•</li>
</ul>
<p>å¤§å®¶å¯èƒ½ä¼šè¯´, å†…éƒ¨çš„è°ƒåº¦å¥½åƒä¹Ÿåªçœ‹åˆ°äº†æš‚åœ, æ²¡æœ‰æ¢å¤å•Š. å®é™…ä¸Š JS æœ‰ä¸ª<img src="https://cdn.nlark.com/yuque/0/2022/png/25390386/1660616529169-2625fed3-3d17-4881-9b67-e6dcf197fcf4.png#clientId=uc779f550-7e98-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=48&amp;id=u3b945f7d&amp;margin=%5Bobject%20Object%5D&amp;name=2926C6A6.png&amp;originHeight=48&amp;originWidth=48&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=2438&amp;status=done&amp;style=none&amp;taskId=u4a32ee11-6757-4102-b0cd-cb8b29e7d2b&amp;title=&amp;width=48" alt="2926C6A6.png"><code>resume</code>, æ‰€ä»¥ React ç›´æ¥é‡æ–°æ‰§è¡Œä¸€éå‡½æ•°ä¹Ÿå°±æ˜¯ä¸Šé¢çš„<code>performConcurrentWorkOnRoot</code>, è™½ç„¶ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„<code>resume</code>ä½†ä»æ•ˆæœä¸Šæ¥è¯´ä¹Ÿè¾¾åˆ°äº†æ¢å¤çš„ç›®çš„, å®ç°ç±»ä»£æ•°æ•ˆåº”.</p>
<blockquote>
<p>é‡æ–°æ‰§è¡Œ performConcurrentWorkOnRoot å‡½æ•° React åŒæ—¶ä¹Ÿåšäº†ä¸€äº›ä¼˜åŒ–, å¦‚æœä½ çœ‹è¿‡ Fiber èŠ‚ç‚¹ä¸­çš„ç»“æ„, ä¼šå‘ç°å†…éƒ¨æœ‰ä¸€ä¸ª memorizedProps(æ›´æ–°ç»“æŸæˆ–æš‚å®šæ—¶å®šä¹‰) å’Œ pendingProps(æ›´æ–°å¼€å§‹æ—¶å®šä¹‰) å±æ€§. åœ¨å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šå¯¹æ¯”è¿™ä¸¤ä¸ªå±æ€§, å¦‚æœä¸¤ä¸ªå±æ€§ç›¸ç­‰å°±å¤ç”¨ä¸Šä¸€æ¬¡çš„æ›´æ–°ç»“æœ, è¿™å°±æ˜¯ React æ‰€è¯´çš„å¤ç”¨å·²å®Œæˆçš„ä»»åŠ¡ç»“æœ.</p>
</blockquote>
<h4 id="æ€»ç»“-2"><a href="#æ€»ç»“-2" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>å…¶å®ä»ä½¿ç”¨ React hooks æ¥è¯´, æˆ‘ä»¬ä¸ç”¨å…³å¿ƒå¦‚ä½•ä½¿ç”¨ä»£æ•°æ•ˆåº”. React å†…éƒ¨å·²ç»å¸®æˆ‘ä»¬å¤„ç†äº† <code>continuation</code>å’Œ <code>resume</code>ç”šè‡³<code>effect</code>, è€Œæˆ‘ä»¬åªéœ€è¦ä¸“æ³¨äº<code>handle</code>ä¸šåŠ¡é€»è¾‘</p>
<p>ä»¥ useState ä¸ºä¾‹:<code>const [count, setCount] = useState()</code></p>
<ul>
<li>å°±å¯ä»¥çœ‹åš<code>perform state()</code>è¯·æ±‚ count çš„ <code>effect</code></li>
<li>ç”± React ä¸­<code>shouldYield</code>æš‚åœ Fiber æ›´æ–°, ç­‰ä»·äºæš‚åœå½“å‰å‡½æ•°</li>
<li>é‡æ–°æ‰§è¡Œ <code>continuationCallback</code>ç­‰ä»·äº <code>resume</code>æ¢å¤æ‰§è¡Œ</li>
<li>æˆ‘ä»¬éœ€è¦çš„ä¸šåŠ¡é€»è¾‘<code>handle</code>effect</li>
</ul>
<h3 id="Suspense"><a href="#Suspense" class="headerlink" title="Suspense"></a>Suspense</h3><p>React ä¸­çš„ Suspense æ˜¯ä¸ªæ›´å…¸å‹çš„ä¾‹å­, æˆ‘ä»¬å…ˆç”¨å®˜æ–¹çš„ä¾‹å­çœ‹çœ‹ Suspense æ˜¯å¦‚ä½•ä½¿ç”¨çš„<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™é‡Œå†…éƒ¨ throw äº†ä¸€ä¸ª Promise</span></span><br><span class="line"><span class="keyword">const</span> resource = fetchProfileData();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfilePage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Suspense fallback=&#123;&lt;h1&gt;Loading profile...&lt;<span class="regexp">/h1&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">      &lt;ProfileDetails /</span>&gt;</span><br><span class="line">      &lt;Suspense fallback=&#123;&lt;h1&gt;Loading posts...&lt;<span class="regexp">/h1&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &lt;ProfileTimeline /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>Suspense&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfileDetails</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Try to read user info, although it might not have loaded yet</span></span><br><span class="line">  <span class="keyword">const</span> user = resource.user.read();</span><br><span class="line">  <span class="keyword">return</span> &lt;h1&gt;&#123;user.name&#125;&lt;/h1&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfileTimeline</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Try to read posts, although they might not have loaded yet</span></span><br><span class="line">  <span class="keyword">const</span> posts = resource.posts.read();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">      &#123;posts.map(<span class="function"><span class="params">post</span> =&gt;</span> (</span><br><span class="line">        &lt;li key=&#123;post.id&#125;&gt;&#123;post.text&#125;&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">      ))&#125;</span></span><br><span class="line"><span class="regexp">    &lt;/u</span>l&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>å­ç»„ä»¶å¼‚æ­¥è¯»å–æ•°æ®, å°†æ•°æ®æ¸²æŸ“åœ¨ç»„ä»¶ä¸­</li>
<li>å¦‚æœæ•°æ®æœªåŠ è½½å®Œæ¯•, React ä¼šæš‚åœæ¸²æŸ“è¯¥ç»„ä»¶, è½¬è€Œæ¸²æŸ“ <code>fallback</code>ç»„ä»¶</li>
<li>ç­‰åˆ°æ•°æ®å°±ç»ª, ä»æš‚åœä½ç½®ç»§ç»­æ¸²æŸ“å­ç»„ä»¶</li>
</ul>
<p>ä»¥ä»£æ•°æ•ˆåº”æ¥è§£è¯»</p>
<ul>
<li><code>resource.user.read()</code>å†…éƒ¨<code>throw promise</code>ç­‰ä»·äº <code>perform resource.user.read()</code></li>
<li>react å†…éƒ¨<code>catch</code>åˆ°<code>thenable</code>çš„å‡½æ•°æ”¾è¿›<code>updateQueue</code>æ›´æ–°é˜Ÿåˆ—ä¸­,  å¯¹åº”ç»„ä»¶ä¼šè¢«æ ‡è®°ä¸º<code>mode: &#39;hidden&#39;</code>. ç›¸å½“äºæš‚åœäº†å½“å‰å‡½æ•°çš„æ‰§è¡Œ(PS: å…¶å®è¿™ä¸ªæ—¶å€™å­ç»„ä»¶çš„å¯¹åº” Fiber å’Œå¯¹åº”å…³ç³»å·²ç»åˆ›å»ºå¥½, åªæ˜¯æ”¾åœ¨ç¼“å­˜æ± äº†)</li>
<li>åœ¨<code>promise</code>å®Œæˆå, React ä¼šåœ¨ commit é˜¶æ®µé‡æ–°è°ƒåº¦æ¸²æŸ“å­ç»„ä»¶, å…¶å®å°±æ˜¯æ¢å¤æ‰§è¡Œäº†.  </li>
</ul>
<blockquote>
<p>è™½ç„¶æœ¬è´¨ä¸Šä¹Ÿä¸æ˜¯æ¢å¤äº†å‡½æ•°, ä¸è¿‡åœ¨ React çœ‹æ¥è¿™é‡Œé‡æ–°æ¸²æŸ“ç»„ä»¶å’Œæ¢å¤æ‰§è¡Œæ²¡ä»€ä¹ˆåŒºåˆ«. å› ä¸ºåœ¨ Suspense å†…éƒ¨ä¸ç®¡æ˜¯ fallback è¿˜æ˜¯å­ç»„ä»¶éƒ½åªä¼šåˆ›å»ºä¸€æ¬¡åŒæ—¶&gt; ä¼šå»ºç«‹å¥½èŠ‚ç‚¹ä¹‹é—´çš„å¯¹åº”å…³ç³», åç»­ rerender çš„æ—¶å€™åªæ˜¯æ”¹å˜äº† child çš„æŒ‡é’ˆç½¢äº†</p>
</blockquote>
<h2 id="æ€»ç»“-3"><a href="#æ€»ç»“-3" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä»£æ•°æ•ˆåº”æœ¬è´¨ä¸Šå°±æ˜¯æŠŠâ€åšä»€ä¹ˆâ€å’Œâ€å¦‚ä½•åšâ€è¿™ä¸¤ä»¶äº‹å„¿åˆ†ç¦»äº†, åŒæ—¶æä¾›äº†å¯¹æµç¨‹æ§åˆ¶çš„èƒ½åŠ›. React ä¹Ÿæ˜¯ç»“åˆäº†è¿™äº›ç‰¹å¾, ä»åŸæ¥ä¾èµ– JS  åŸç”Ÿè°ƒç”¨æ ˆåŒæ­¥æ›´æ–°æ–¹å¼é‡æ„ä¸ºäº†ç°åœ¨ Fiber Reconciler è‡ªå·±æ¨¡æ‹Ÿäº†ä¸€å¥—ç»„ä»¶è°ƒç”¨æ ˆ/Hooks/Suspense ä¸€ç³»åˆ—çš„æ–°ç‰¹æ€§. ä¹Ÿå°è¯äº† React Hooks ä½œè€…çš„é‚£ä¸€å¥è¯<code>æˆ‘ä»¬åœ¨ React ä¸­æ‰€åšçš„äº‹å°±æ˜¯åœ¨è·µè¡Œä»£æ•°æ•ˆåº”</code></p>
<blockquote>
<p>å…¶å®å‡ºäº† React ä»¥å¤–è¿˜æœ‰å…¶ä»–åº“ä¹Ÿä½¿ç”¨äº†ä»£æ•°æ•ˆåº”ä½œä¸ºå¿ƒæ™ºæ¨¡å‹, å¯ä»¥æ€è€ƒçœ‹çœ‹â€¦ æˆ–è®¸â€¦ä¹Ÿå¯ä»¥è‡ªå·±é€ ä¸ªè½®å­?</p>
</blockquote>
<h3 id="Referer"><a href="#Referer" class="headerlink" title="Referer"></a>Referer</h3><ul>
<li><a href="https://dev.to/yelouafi/algebraic-effects-in-javascript-part-1---continuations-and-control-transfer-3g88" target="_blank" rel="noopener">continuations-and-control-transfer</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/380855727" target="_blank" rel="noopener">å¹²è´§ï½œè¯¦è§£Algebraic Effectsä»£æ•°æ•ˆåº”</a></li>
<li><a href="https://overreacted.io/zh-hans/algebraic-effects-for-the-rest-of-us/" target="_blank" rel="noopener">Algebraic Effects for the Rest of Us</a></li>
</ul>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-08-23</span><i class="fa fa-tag"></i><a href="/categories/ç¬”è®°ğŸ“’/" title="ç¬”è®°ğŸ“’" class="tag">ç¬”è®°ğŸ“’ </a><a href="/tags/React/" title="React" class="tag">React </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,https://yoursite.com/2022/08/23/Algebraic-Effects-React/,Cara's Blog,Algebraic Effects &amp; React,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a role="navigation" href="/2022/03/25/ç»†è¯´HTTPå˜åŒ–å²/" title="ç»†è¯´HTTPå˜åŒ–å²" class="btn">ä¸‹ä¸€ç¯‡</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>