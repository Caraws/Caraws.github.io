<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Author Name,name@example.com"><title>Promise åˆ†æåŠå®ç° Â· Cara's Blog</title><meta name="description" content="Promise æ˜¯ ES6ä¸­ä¸­æ”¶å½•çš„å¼‚æ­¥æ“ä½œå°è£…, é€šå¸¸åœ¨å›è°ƒ/ äº‹ä»¶/ æ¶ˆæ¯ç­‰å¼‚æ­¥æ“ä½œä¸­æœ‰æ˜¾è‘—çš„ä¼˜åŠ¿, è®©æˆ‘ä»¬åœ¨æ›´æ–¹ä¾¿çš„æ“ä½œå¼‚æ­¥ä¹Ÿè®©ä»£ç æ›´åŠ æ¸…æ™°.åŒ…æ‹¬ ES7ä¸­çš„ Async/Await ä¹Ÿæ˜¯å¯¹å¼‚æ­¥æ“ä½œçš„å°è£…, ä¸è¿‡ Async æ›´åƒæ˜¯ Generator çš„è¯­æ³•ç³–.
åŸºç¡€å®ç°å­¦ä¹ å‰–æ Promi"><meta name="keywords" content="Hexo,HTML,CSS,android,Linux"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/avator.jpg" style="width:127px;"><h3 title=""><a href="/">Cara's Blog</a></h3><div class="description"><p>å’¸é±¼çš„å­¦ä¹ ğŸ“’ Lok'tar</p></div></div></div><ul class="social-links"><li><a href="/atom.xml"><i class="fa fa-rss"></i></a></li><li><a href="http://github.com/Caraws"><i class="fa fa-github"></i></a></li></ul><div class="footer"></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">é¦–é¡µ</a></li><li><a href="/archives">å½’æ¡£</a></li><li><a href="/about">å…³äº</a></li><li><a href="/links">å‹é“¾</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="/images/favicon.jpeg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Promise åˆ†æåŠå®ç°</a></h3></div><div class="post-content"><p>Promise æ˜¯ ES6ä¸­ä¸­æ”¶å½•çš„å¼‚æ­¥æ“ä½œå°è£…, é€šå¸¸åœ¨å›è°ƒ/ äº‹ä»¶/ æ¶ˆæ¯ç­‰å¼‚æ­¥æ“ä½œä¸­æœ‰æ˜¾è‘—çš„ä¼˜åŠ¿, è®©æˆ‘ä»¬åœ¨æ›´æ–¹ä¾¿çš„æ“ä½œå¼‚æ­¥ä¹Ÿè®©ä»£ç æ›´åŠ æ¸…æ™°.åŒ…æ‹¬ ES7ä¸­çš„ Async/Await ä¹Ÿæ˜¯å¯¹å¼‚æ­¥æ“ä½œçš„å°è£…, ä¸è¿‡ Async æ›´åƒæ˜¯ Generator çš„è¯­æ³•ç³–.</p>
<h3 id="åŸºç¡€å®ç°"><a href="#åŸºç¡€å®ç°" class="headerlink" title="åŸºç¡€å®ç°"></a>åŸºç¡€å®ç°</h3><p>å­¦ä¹ <a href="https://tech.meituan.com/promise-insight.html" target="_blank" rel="noopener">å‰–æ Promise ä¹‹åŸºç¡€ç¯‡</a>ç”¨ä¸€ä¸ªæœ€å¸¸è§çš„åº”ç”¨æ¥å‰–æ <code>Promise</code>, é€šè¿‡å¼‚æ­¥è·å–ç”¨æˆ· Id, ç„¶åä½œä¸€äº›å¤„ç†. å¹³å¸¸æˆ‘ä»¬æœ€å¸¸ç”¨çš„æ˜¯å›è°ƒçš„æ–¹å¼æ¥å¤„ç†, ä¸‹é¢ç”¨ <code>Promise</code> çš„æ–¹å¼æ¥å¤„ç†.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getUserId = <span class="function"><span class="params">_</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        axios.get(<span class="string">'http://example.com/api'</span>, <span class="attr">params</span>: param).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            resolve(<span class="built_in">JSON</span>.parse(res).id)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">getUserId().then(<span class="function"><span class="params">id</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(id)</span><br><span class="line">    <span class="comment">// do something...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>getUserId å‡½æ•°è¿”å›ä¸€ä¸ª <code>Promise</code>, åœ¨ä»–çš„ <code>then</code> æ–¹æ³•ä¸­æ”¾å…¥å¼‚æ­¥æ“ä½œæˆåŠŸä¹‹åçš„å›è°ƒå‡½æ•°. è¿™ç§æ–¹å¼æ˜æ˜¾æ¯”æˆ‘ä»¬ä¹‹å‰å¸¸ç”¨çš„å›è°ƒå‡½æ•°æ›´åŠ æ–¹ä¾¿è€Œä¸”æ˜“è¯», ä¹Ÿæ›´åŠ å®¹æ˜“é¿å… callback hell.</p>
<p>é‚£ä¹ˆæ»¡è¶³è¿™æ ·çš„åœºæ™¯çš„<code>Promise</code>æ˜¯æ€æ ·å®ç°çš„å‘¢, ä¸‹é¢æˆ‘ä»¬å¯ä»¥ç®€å•çš„å®ç°ä¸€ä¸‹æœ€åŸºç¡€çš„<code>Promise</code>:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Promise</span> (<span class="params">fn</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> value = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">let</span> deferreds = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. å­˜å…¥å¼‚æ­¥æˆåŠŸéœ€è¦çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">    <span class="comment">// æ­¤æ—¶æŒ‡å‘ä¸¤ä¸ªå›è°ƒå‡½æ•° id =&gt; &#123;&#125;</span></span><br><span class="line">    <span class="keyword">this</span>.then = <span class="function"><span class="keyword">function</span> (<span class="params">onFulfilled</span>) </span>&#123;</span><br><span class="line">        deferreds.push(onFulfilled)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. æ‰§è¡Œ deferreds é˜Ÿåˆ—ä¸­çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">    <span class="comment">// æ­¤æ—¶ value ä¸º123</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">resolve</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">        deferreds.map(<span class="function"><span class="params">deferred</span> =&gt;</span> &#123;</span><br><span class="line">            deferred(value)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. æ‰§è¡Œåˆ›å»º Promise å®ä¾‹æ—¶ä¼ å…¥çš„å‡½æ•°</span></span><br><span class="line">    <span class="comment">// å¹¶ä¼ å…¥ resolve ä¾›åœ¨é€‚å½“æ—¶è§¦å‘å›è°ƒ</span></span><br><span class="line">    fn(resolve)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getUserId = <span class="function"><span class="params">_</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 2. æ‰§è¡Œ resolve</span></span><br><span class="line">        resolve(<span class="number">123</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">getUserId().then( <span class="function"><span class="params">id</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'this is callback!'</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(id) <span class="comment">// 123</span></span><br><span class="line">&#125;).then(<span class="function"><span class="params">id</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'this is second callback!'</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(id) <span class="comment">// 123</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<ul>
<li>è°ƒç”¨ <code>then</code> æ–¹æ³•å°†å›è°ƒå‡½æ•°å­˜å…¥ deferreds é˜Ÿåˆ—.</li>
<li>åˆ›å»º <code>Promise</code> å®ä¾‹æ—¶ä¼ å…¥å‡½æ•°å’Œ <code>resolve</code>, <code>resolve</code> ç”¨äºåœ¨é€‚å½“çš„æ—¶é—´è§¦å‘å›è°ƒå‡½æ•°.</li>
<li>çœŸæ­£æ‰§è¡Œå›è°ƒå‡½æ•°çš„æ˜¯ <code>deferreds</code> é˜Ÿåˆ—ä¸­çš„å…ƒç´ .</li>
<li><code>resolve</code> å‡½æ•°æ¥å—ä¸€ä¸ªå‚æ•°, ç”¨äºå›è°ƒå‡½æ•°ä½¿ç”¨, å³å¼‚æ­¥æ“ä½œçš„è¿”å›ç»“æœ.</li>
</ul>
<p>å¯èƒ½å¤§å®¶å·²ç»å‘ç°, ä»¥ä¸Šä»£ç å¹¶ä¸èƒ½çœŸæ­£æ‰§è¡Œåˆ°å›è°ƒå‡½æ•°.æ ¹æ®ä¸Šé¢æ ‡æ³¨çš„åºå·å°±æ˜¯ä»£ç çš„æ‰§è¡Œé¡ºåº, è¿™æ˜¯å› ä¸ºç°åœ¨è¿˜æ˜¯åŒæ­¥å‡½æ•°, <code>Promise</code> å‡½æ•°ä¸­çš„ <code>resolve</code> å‡½æ•°ä¼šå…ˆäº <code>this.then</code> å‡½æ•°æ‰§è¡Œ,æ­¤æ—¶ <code>deferreds</code> é˜Ÿåˆ—ä¸­è¿˜æ˜¯ç©ºçš„, ä»¥è‡³äºåé¢çš„å›è°ƒå‡½æ•°ä¹Ÿæ— æ³•æ‰§è¡Œ. æ‰€ä»¥æˆ‘ä»¬è¦ä¿è¯å›è°ƒä»¥å¼‚æ­¥çš„æ–¹å¼æ‰§è¡Œ, ä»¥ä¿è¯æ‰§è¡Œé¡ºåº. å¯ä»¥é€šè¿‡ <code>setTimeout</code> å°† <code>resolve</code> ä¸­çš„å›è°ƒå‡½æ•°æ”¾åœ¨æ‰§è¡Œæ ˆçš„æœ«å°¾.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolve</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// å°†æ‰§è¡Œçš„å›è°ƒçš„é€»è¾‘æ”¾å…¥æ‰§è¡Œæ ˆæœ«å°¾</span></span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        deferreds.map(<span class="function"><span class="params">deferred</span> =&gt;</span> &#123;</span><br><span class="line">            deferred(value)</span><br><span class="line">        &#125;)    </span><br><span class="line">    &#125;, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ç°åœ¨å°±å¯ä»¥çœ‹åˆ°, then ä¸­çš„å›è°ƒå‡½æ•°èƒ½å¤Ÿæ­£å¸¸æ‰§è¡Œäº†.</p>
<h4 id="å¼•å…¥çŠ¶æ€"><a href="#å¼•å…¥çŠ¶æ€" class="headerlink" title="å¼•å…¥çŠ¶æ€"></a>å¼•å…¥çŠ¶æ€</h4><p>ç°åœ¨æˆ‘ä»¬å¼•å…¥è§„èŒƒ <code>Promises/A+</code> ä¸­æ‰€è¯´çš„ States, å®ƒæœ‰ä¸‰ä¸ªäº’æ–¥çš„çŠ¶æ€: pending/ fulfilled/ rejected.</p>
<p>ç°åœ¨æˆ‘ä»¬æ¥æ”¹è¿›ä¸‹ä»£ç :<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Promise</span> (<span class="params">fn</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> value = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">let</span> deferreds = []</span><br><span class="line">    <span class="keyword">let</span> state = <span class="string">'pending'</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">this</span>.then = <span class="function"><span class="keyword">function</span> (<span class="params">onFulfilled</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (state === <span class="string">'pending'</span>) &#123;</span><br><span class="line">            deferreds.push(onFulfilled)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">        &#125;</span><br><span class="line">        onFulfilled(value)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">resolve</span> (<span class="params">newValue</span>) </span>&#123;</span><br><span class="line">        value = newValue</span><br><span class="line">        state = <span class="string">'fulfilled'</span></span><br><span class="line">        setTimeout(<span class="function"><span class="params">_</span> =&gt;</span> &#123;</span><br><span class="line">            deferreds.map(<span class="function"><span class="params">deferred</span> =&gt;</span> &#123;</span><br><span class="line">                deferred(value)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    fn(resolve)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="ä¸²è¡Œ-Promise"><a href="#ä¸²è¡Œ-Promise" class="headerlink" title="ä¸²è¡Œ Promise"></a>ä¸²è¡Œ Promise</h3><p>ä¸²è¡Œ <code>Promise</code> æ˜¯æŒ‡å½“ promise è¾¾åˆ° fuifilled çŠ¶æ€ä¹‹å, å†è¿›è¡Œä¸‹ä¸€ä¸ª promise. æ¯”å¦‚ä¸Šä¾‹ä¸­çš„æˆ‘ä»¬æ‹¿åˆ° userId ä¹‹åè¿˜éœ€è¦ç”¨è¿™ä¸ª userId å»è·å–ç”¨æˆ·çš„åç§°/ ä½å€/ æ‰‹æœºå·ç­‰å…¶ä»–ä¿¡æ¯.</p>
<p>ä½¿ç”¨çš„ä¼ªä»£ç ç±»ä¼¼è¿™æ ·:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">getUserId()</span><br><span class="line">    .then(getUserInfoById)</span><br><span class="line">    .then(<span class="function"><span class="params">userInfo</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">const</span> getUserInfoById = <span class="function"><span class="params">id</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        axios.get(<span class="string">'http://example.com/api'</span>, <span class="attr">params</span>: &#123;</span><br><span class="line">            id: <span class="number">123</span></span><br><span class="line">        &#125;).then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">            resolve(<span class="built_in">JSON</span>.parse(response).info)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> getUserId = <span class="function"><span class="params">_</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        resolve(<span class="number">123</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä¸²è¡Œçš„å›°éš¾åœ¨äºå¦‚ä½•å°†å‰åçš„ <code>Promise</code> è¡”æ¥èµ·æ¥, é¦–å…ˆå¯¹ <code>then</code> æ–¹æ³•æ”¹é€ :<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.then = <span class="function"><span class="keyword">function</span> (<span class="params">onFulfilled</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// bridge promise</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        handle(&#123;</span><br><span class="line">            onFulfilled: onFulfilled || <span class="literal">null</span>,</span><br><span class="line">            resolve: resolve</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> handle = <span class="function"><span class="params">deferred</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (state === <span class="string">'pending'</span>) &#123;</span><br><span class="line">        deferreds.push(deferred)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> ret = deferred.onFulfilled(value)</span><br><span class="line">    deferred.resolve(ret)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>then</code> æ–¹æ³•ä¸­è¿”å›ä¸€ä¸ªæ–°åˆ›å»ºçš„ Promise å®ä¾‹ä½œä¸ºè¿”å›å€¼, è¿™æ˜¯ä¸²è¡Œçš„åŸºç¡€, ç”±äºè¿”å›ç±»å‹ä¸€æ ·æ‰€ä»¥ä¾ç„¶æ”¯æŒé“¾å¼.</li>
<li><code>then</code> æ–¹æ³•ä¸­çš„å½¢å‚ <code>onFulfilled</code> å’Œæ–°åˆ›å»ºçš„ Promise å®ä¾‹ä¸­çš„ <code>resolve</code> å‡æ”¾å…¥å½“å‰ promise çš„ deferreds é˜Ÿåˆ—ä¸­.</li>
<li><code>handle</code> æ–¹æ³•ä½œä¸ºå½“å‰ promise çš„å†…éƒ¨æ–¹æ³•, è¾ƒä¹‹å‰çš„ <code>then</code> æ–¹æ³•åªå¢åŠ äº†ä¸€è¡Œ<code>deferred.resolve(ret)</code>.</li>
</ul>
<p>åœ¨å½“å‰ promise çš„å¼‚æ­¥æˆåŠŸä¹‹åæ‰§è¡Œ <code>handle</code> æ–¹æ³•æ—¶, å…ˆæ‰§è¡Œ <code>onFulfilled</code> æ–¹æ³•, ç„¶åå°†å…¶è¿”å›å€¼ä½œä¸º <code>resolve</code> æ–¹æ³•çš„å®å‚ä¼ å…¥.</p>
<p>å†æ”¹é€  <code>resolve</code> æ–¹æ³•, æŠŠä»£ç æ•´ç†ä¸€ä¸‹:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Promise</span> (<span class="params">fn</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> value = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">let</span> deferreds = []</span><br><span class="line">    <span class="keyword">let</span> state = <span class="string">'pending'</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">this</span>.then = <span class="function"><span class="keyword">function</span> (<span class="params">onFulfilled</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ Promiseä½œä¸ºè¿”å›å€¼</span></span><br><span class="line">        <span class="comment">// å°†å½“å‰ promise çš„å›è°ƒå‡½æ•°å’Œæ–°åˆ›å»ºçš„ resolve</span></span><br><span class="line">        <span class="comment">// æ”¾å…¥ deferreds é˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span> (<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">            handle(&#123;</span><br><span class="line">                onFulfilled: onFulfilled || <span class="literal">null</span></span><br><span class="line">                resolve: resolve</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> handle = <span class="function"><span class="params">deferred</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–çŠ¶æ€æ—¶, å¾€ deferreds é˜Ÿåˆ—æ·»åŠ </span></span><br><span class="line">        <span class="keyword">if</span> (state === <span class="string">'pending'</span>) &#123;</span><br><span class="line">            deferreds.push(deferred)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å½“å‰ promise è¾¾åˆ° 'fulfilled' çŠ¶æ€ä¹‹å</span></span><br><span class="line">        <span class="comment">// å…ˆæ‰§è¡Œå›è°ƒå‡½æ•°, å†å°†å›è°ƒå‡½æ•°çš„è¿”å›å€¼(ret)</span></span><br><span class="line">        <span class="comment">// ä¼ é€’ç»™ resolve å‡½æ•°</span></span><br><span class="line">        <span class="keyword">let</span> ret = deferred.onFulfilled(value)</span><br><span class="line">        deferred.resolve(ret)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> resolve = <span class="function"><span class="params">newValue</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (newValue &amp;&amp; (<span class="keyword">typeof</span> newValue === <span class="string">'object'</span> || <span class="keyword">typeof</span> newValue === <span class="string">'function'</span>)) &#123;</span><br><span class="line">            <span class="keyword">let</span> then = newValue.then</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> then === <span class="string">'function'</span>) &#123;</span><br><span class="line">                then.call(newValue, resolve)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        value = newValue</span><br><span class="line">        state = <span class="string">'fulfilled'</span></span><br><span class="line">        setTimeout(<span class="function"><span class="params">_</span> =&gt;</span> &#123;</span><br><span class="line">            deferreds.map(<span class="function"><span class="params">deferred</span> =&gt;</span> &#123;</span><br><span class="line">                handle(deferred)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ‰§è¡Œ promise å®ä¾‹ä¸­çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">    fn(resolve)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getUserId()</span><br><span class="line">    .then(getUserInfoById)</span><br><span class="line">    .then(<span class="function"><span class="params">userInfo</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'this is second callback'</span>)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure></p>
<p>ç°åœ¨ <code>resolve</code> æ”¯æŒä¼ å…¥ä¸€ä¸ª promise å®ä¾‹çš„å‚æ•°äº†, æ‰§è¡Œé¡ºåºå¦‚ä¸‹:</p>
<ol>
<li><code>getUserId</code> ç”Ÿæˆçš„ promise1, è¿›å…¥ Promise å‡½æ•°æ‰§è¡Œ <code>fn(resolve)</code> ç”±äº<code>getUserId</code> çš„å†…éƒ¨æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œ, ä¸‹ä¸€æ­¥ä¼šç›´æ¥æ‰§è¡Œ <code>this.then(onFulfilled)</code>.</li>
<li><code>this.then()</code> è¿”å›ä¸€ä¸ªæ–°çš„ promise2 å‡½æ•°( å³: bridge promise)ä½œä¸ºé“¾å¼è°ƒç”¨, promise2 é‡æ–°å®ä¾‹åŒ–å†æ‰§è¡Œ <code>fn(resolve)</code>, åˆ™è¿›å…¥<code>handle({...})</code> æ­¤æ—¶ handle çš„å‚æ•°ä¸º getUserInfoById å’Œ resolve2, æ¥ç€è¢« push åˆ° <code>deferreds1</code> é˜Ÿåˆ—ä¸­; å†æ¥ç€æ‰§è¡Œä¸‹ä¸€ä¸ª<code>this.then()</code> ç”Ÿæˆ promise3, <code>deferreds2</code> é˜Ÿåˆ—ä¸­ push è¿›ç¬¬äºŒä¸ª then çš„åŒ¿åå‡½æ•°(userInfo =&gt; {â€¦}) å’Œ resolve3.</li>
<li>æ‰§è¡Œ<code>resolve(123)</code>, è¿›å…¥ <code>resolve(newValue)</code> æ‰§è¡Œ<code>handle(deferred)</code> æ­¤æ—¶ deferred ä¸º getUserInfoById å’Œ resolve2, æ‰§è¡Œ handle å†…éƒ¨çš„ <code>deferred.onFulfilled(value)</code> ä¹Ÿå°±æ˜¯ getUserInfoById æ–¹æ³•ä»è€Œç”Ÿæˆ promise4, å†åˆ° <code>deferred.resolve(ret)</code> è¿™ä¸ªæ—¶å€™ ret å°±ä¸º promise4, ä¼ å…¥ <code>resolve(newValue)</code> æ‰§è¡Œ <code>then.call(promise4, resolve2)</code>.</li>
<li>æ¥ç€ä¸Šä¸€æ­¥è¿›å…¥ <code>this.then()</code> ç”Ÿæˆ promise5(bridge promise), deferred4 å‹å…¥ resolve2 å’Œ resolve5; åœ¨æ‰§è¡Œ getUserInfoById ä¸­çš„ <code>resolve({name: &#39;cara&#39;...})</code>, è¿›å…¥ setTimeout ä¸­çš„ <code>handle(deferred)</code>, åˆ° handle å‡½æ•°å†…éƒ¨ <code>deferred.onFulfilled(value)</code> å…¶å®æ‰§è¡Œçš„æ˜¯ <code>resolve2({...})</code> resolve2ä¸­çš„ <code>deferred</code> ä¿å­˜çš„æ˜¯çš„ <code>uerInfo =&gt; {}</code> åŒ¿åå‡½æ•°å’Œ <code>resolve3</code>; <code>deferred.resolve</code> å…¶å®æ‰§è¡Œçš„æ˜¯ <code>resolve5</code>, ç”±äº resolve3 å’Œ resolve5 ä¸­çš„ <code>deferred</code> éƒ½æ˜¯ç©ºçš„äºæ˜¯å®Œæˆæ•´ä¸ªæµç¨‹.</li>
</ol>
<p>æ¥ä¸‹æ¥å†åŠ å…¥é”™è¯¯å¤„ç†å’Œå¼‚å¸¸åˆ¤æ–­:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Promise</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> state = <span class="string">'pending'</span>,</span><br><span class="line">        value = <span class="literal">null</span>,</span><br><span class="line">        deferreds = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.then = <span class="function"><span class="keyword">function</span> (<span class="params">onFulfilled, onRejected</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">            handle(&#123;</span><br><span class="line">                onFulfilled: onFulfilled || <span class="literal">null</span>,</span><br><span class="line">                onRejected: onRejected || <span class="literal">null</span>,</span><br><span class="line">                resolve: resolve,</span><br><span class="line">                reject: reject</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">deferred</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (state === <span class="string">'pending'</span>) &#123;</span><br><span class="line">            deferreds.push(deferred);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> cb = state === <span class="string">'fulfilled'</span> </span><br><span class="line">            ? deferred.onFulfilled </span><br><span class="line">            : deferred.onRejected,</span><br><span class="line">                ret;</span><br><span class="line">        <span class="keyword">if</span> (cb === <span class="literal">null</span>) &#123;</span><br><span class="line">            cb = state === <span class="string">'fulfilled'</span> </span><br><span class="line">                ? deferred.resolve </span><br><span class="line">                : deferred.reject;</span><br><span class="line">            cb(value);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ret = cb(value);</span><br><span class="line">            deferred.resolve(ret);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            deferred.reject(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">resolve</span>(<span class="params">newValue</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (newValue &amp;&amp; (<span class="keyword">typeof</span> newValue === <span class="string">'object'</span> || <span class="keyword">typeof</span> newValue === <span class="string">'function'</span>)) &#123;</span><br><span class="line">            <span class="keyword">var</span> then = newValue.then;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> then === <span class="string">'function'</span>) &#123;</span><br><span class="line">                then.call(newValue, resolve, reject);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        state = <span class="string">'fulfilled'</span>;</span><br><span class="line">        value = newValue;</span><br><span class="line">        finale();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">reject</span>(<span class="params">reason</span>) </span>&#123;</span><br><span class="line">        state = <span class="string">'rejected'</span>;</span><br><span class="line">        value = reason;</span><br><span class="line">        finale();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">finale</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            deferreds.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">deferred</span>) </span>&#123;</span><br><span class="line">                handle(deferred);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fn(resolve, reject);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>ä¹‹å‰çš„æ–‡å­—æè¿°ä¸å¥½ç†è§£, æ‰€ä»¥è¿˜æ˜¯ç”»äº†ä¸€ä¸ªæ‰§è¡Œæµç¨‹å›¾</strong><br><img src="/img/Promiseæ‰§è¡Œè¿‡ç¨‹.png" alt="promiseæ‰§è¡Œè¿‡ç¨‹"></p>
<p>æ²¡æœ‰ç”» <code>reject</code> çš„æƒ…å†µ, å› ä¸º<code>reject</code> è·Ÿ <code>resolve</code> çš„æµç¨‹æ˜¯ä¸€æ ·çš„, ä¸¤ä¸ªä¸€èµ·ç”»æ˜¾å¾—æ›´ä¹±å°±å•ç‹¬æŠŠ <code>resolve</code> æ‹å‡ºæ¥. åœ¨åŠ å…¥ <code>handle</code> å’Œ <code>resolve</code> åœ¨ promise å‡½æ•°ä¸­ä½œä¸ºå†…éƒ¨æ–¹æ³•åå®åœ¨ä¸æ˜“ç†è§£. ä¸»è¦å°±æ˜¯é€šè¿‡é—­åŒ…æ¥ä¿å­˜ promise å¯¹è±¡çš„å˜é‡å¼•ç”¨, å°†å›è°ƒå‡½æ•°å’Œ resolve å‡½æ•°ä¿å­˜åœ¨ç¼“å­˜é˜Ÿåˆ—ä¸­, åœ¨é€šè¿‡ resolve å®Œæˆé“¾å¼è°ƒç”¨.</p>
<h2 id="å…¶ä»–å®ç°"><a href="#å…¶ä»–å®ç°" class="headerlink" title="å…¶ä»–å®ç°"></a>å…¶ä»–å®ç°</h2><p>çœ‹å®Œä¹‹å‰çš„é‚£ç¯‡æ–‡ç« å®åœ¨è§‰å¾—æœ‰ç‚¹éš¾ç†è§£, äºæ˜¯åˆæ‰¾äº†å…¶ä»–çš„å®ç°æ–¹å¼<a href="http://bruce-xu.github.io/blogs/js/promise" target="_blank" rel="noopener">JS Promiseçš„å®ç°åŸç†</a>æ¯”ä¹‹å‰é‚£ç¯‡æ›´å¥½ç†è§£ä¸€äº›, æ‰€ä»¥è¿˜æ˜¯è®°å½•ä¸€ä¸‹å¥½äº†.</p>
<blockquote>
<p>è¿™ç¯‡æ–‡ç« ä½œè€…è¯´åˆ°çš„ <code>Promise</code> é‡ç‚¹:</p>
<ol>
<li><code>Promise</code> æ˜¯ä¸€ä¸ªæ‰¿è¯º, æ‰€ä»¥ä¸ç®¡æˆåŠŸä¸å¦éƒ½è¦æœ‰ä¸€ä¸ªæ‰§è¡Œç»“æœ, å› æ­¤ Promise æ„é€ å‡½æ•°æœ‰ä¸€ä¸ªå‡½æ•°ç±»å‹çš„å‚æ•° <code>resolver</code> æ¥ä½œä¸ºä¸è¯¥ promise å¯¹è±¡å…³è”çš„ä»»åŠ¡.</li>
<li>ä¸‰ç§çŠ¶æ€ä¸å¯é€†è½¬.</li>
<li><code>resolver</code> å‡½æ•°å°è£…äº†éœ€è¦æ‰§è¡Œçš„å¼‚æ­¥æ“ä½œ, å†…éƒ¨: <code>resolve</code> å’Œ <code>reject</code> ä¸¤ä¸ªå‚æ•°; åˆ†åˆ«ä»£è¡¨æ‰§è¡ŒæˆåŠŸå’Œæ‰§è¡Œå¤±è´¥éœ€è¦æ‰§è¡Œçš„æ“ä½œ.</li>
<li><code>then</code> æä¾›æˆåŠŸæˆ–å¤±è´¥çš„å“åº”å¤„ç†, äºæ˜¯æœ‰äº†<code>onResolve</code> å’Œ <code>onReject</code>.</li>
<li><code>then</code> æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„ promise(bridge promise), æä¾›é“¾å¼æ“ä½œåŠä¸²è¡Œ, å¦‚æœç›´æ¥è¿”å› this é‚£ä¹ˆå°±æ˜¯å¹¶è¡Œæ˜¾ç„¶ä¸ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚. å‰ä¸€ä¸ª promise éœ€è¦çŸ¥é“ä¸‹ä¸€ä¸ª promise å¯¹è±¡æ˜¯è°åŠå…¶ä»»åŠ¡å¼•ç”¨, è€Œåä¸€ä¸ª promise è¦æä¾›ä¸€ä¸ªç»™å‰ä¸€ä¸ª promise æˆåŠŸæˆ–å¤±è´¥æ—¶éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡, å› æ­¤æ·»åŠ ä¸€ä¸ªé—­åŒ…</li>
<li><code>makeCallback</code> è°ƒç”¨å°† promise åŠå…¶å…³è”ä»»åŠ¡ä¼ é€’è¿›å», è¿”å›ä¸€ä¸ªæ–°å‡½æ•°, å‰ä¸€ä¸ª promise å¯¹è±¡å°±å°†æŒæœ‰è¿”å›å‡½æ•°çš„å¼•ç”¨, è°ƒç”¨è¿”å›å‡½æ•°æ—¶å°±èƒ½è®¿é—®åˆ° promise å¯¹è±¡å’Œå…³è”ä»»åŠ¡.</li>
<li><code>resolve</code> å’Œ <code>reject</code> å‡½æ•°åœ¨å¼‚æ­¥æˆåŠŸæˆ–å¤±è´¥çš„æ—¶å€™è°ƒç”¨, å¹¶ä¼ é€’æˆåŠŸçš„æ•°æ®å’Œå¤±è´¥çš„åŸå› .</li>
<li><code>run</code> å‡½æ•°æ‰§è¡Œå¼‚æ­¥ç›¸å…³çš„å›è°ƒå‡½æ•°.</li>
</ol>
</blockquote>
<h3 id="ä»£ç ç»“æ„"><a href="#ä»£ç ç»“æ„" class="headerlink" title="ä»£ç ç»“æ„"></a>ä»£ç ç»“æ„</h3><ul>
<li>æ„é€ å‡½æ•°</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Promise</span> (<span class="params">resolver</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">this</span>._status = <span class="string">'pending'</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æˆåŠŸé˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">this</span>._doneCallbacks = []</span><br><span class="line">    <span class="comment">// å¤±è´¥é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">this</span>._failCallbacks = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¼ é€’å…³è”ä»»åŠ¡</span></span><br><span class="line">    resolver(resolve, reject)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>then</code> æ–¹æ³•</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.prototype.then = <span class="function"><span class="keyword">function</span> (<span class="params">onResolve, onReject</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// æ·»åŠ é—­åŒ…è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">_</span> =&gt;</span> &#123;&#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¿å­˜å¯¹ä¸Šä¸€ä¸ª promise çš„å¼•ç”¨</span></span><br><span class="line">    <span class="keyword">this</span>._doneCallbacks.push(makeCallback(promise, onResolve, <span class="string">'reslove'</span>))</span><br><span class="line">    <span class="keyword">this</span>._failCallbacks.push(makeCallback(promise, onReject, <span class="string">'reject'</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> promise</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>makeCallback</code> å‡½æ•°</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// promise å¯¹è±¡/ å›è°ƒå‡½æ•°(å…³è”ä»»åŠ¡)/ ç±»å‹</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCallback</span> (<span class="params">promise, callback, action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">promiseCallback</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>resolve</code> å‡½æ•°å’Œ <code>reject</code> å‡½æ•°<br>è¿™ä¸¤ä¸ªå‡½æ•°éƒ½éœ€è¦ä¸€ä¸ªå‚æ•°æ¥æ¥æ”¶ç»“æœ, ç”±äºçŠ¶æ€åªèƒ½è½¬æ¢ä¸€æ¬¡æ‰€ä»¥ä¸¤ä¸ªå‡½æ•°éƒ½éœ€è¦åˆ¤æ–­çŠ¶æ€.</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æˆåŠŸ</span></span><br><span class="line"><span class="comment">// promise: å±äºå“ªä¸ª promise å¯¹è±¡</span></span><br><span class="line"><span class="comment">// data: å¼‚æ­¥æ“ä½œçš„ç»“æœ</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolve</span> (<span class="params">promise, data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// å·²ç»è¢« resolve è¿‡çš„è¯ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (promise._status !== <span class="string">'pending'</span>) <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¿®æ”¹ promise çŠ¶æ€</span></span><br><span class="line">    promise._status = <span class="string">'fulfilled'</span></span><br><span class="line">    <span class="comment">// ä¿å­˜å¼‚æ­¥æ“ä½œçš„å€¼</span></span><br><span class="line">    promise._value = data</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰§è¡Œç›¸å…³å›è°ƒå‡½æ•°</span></span><br><span class="line">    run(promise)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤±è´¥</span></span><br><span class="line"><span class="comment">// promise: å±äºå“ªä¸ª promise å¯¹è±¡</span></span><br><span class="line"><span class="comment">// reason: å¤±è´¥åŸå› </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reject</span> (<span class="params">promise, reason</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (promise._status !== <span class="string">'pending'</span>) <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    promise._status = <span class="string">'rejected'</span></span><br><span class="line">    promise._value = reason</span><br><span class="line">    </span><br><span class="line">    run(promise)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>run</code> å‡½æ•°<br>ç”¨æ¥æ‰§è¡Œå¼‚æ­¥ç›¸å…³çš„å›è°ƒå‡½æ•°.</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span> (<span class="params">promise</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// then æ–¹æ³•ä¸­ä¹Ÿä¼šè°ƒç”¨, æ­¤å¤„å†åšä¸€æ¬¡åˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (promise._status === <span class="string">'pending'</span>) <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> value = promise._value</span><br><span class="line">    <span class="comment">// æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">let</span> callbacks = promise._status === <span class="string">'fulfilled'</span></span><br><span class="line">        ? promise._doneCallbacks</span><br><span class="line">        : promise._failCallbacks</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿™é‡Œéœ€è¦å¼‚æ­¥</span></span><br><span class="line">    setTimeout(<span class="function"><span class="params">_</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œå›è°ƒå‡½æ•°</span></span><br><span class="line">        callbacks.map(<span class="function"><span class="params">cb</span> =&gt;</span> cb(value))</span><br><span class="line">    &#125;, <span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    promise._doneCallbacks = []</span><br><span class="line">    promise._failCallbacks = []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>run</code> å‡½æ•°ä¸­çš„ callbacks å°±æ˜¯ <code>makeCallback</code> æ‰€è¿”å›çš„å‡½æ•°</strong></p>
<ul>
<li>å®Œå–„ <code>makeCallback</code> å‡½æ•°</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCallback</span> (<span class="params">promise, callback, action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">promiseCallback</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// å¦‚æœ callback æ˜¯ä¸ªå‡½æ•°, ä½¿ç”¨å‰ä¸€ä¸ª promise</span></span><br><span class="line">        <span class="comment">// ä¼ é€’çš„å€¼ä½œä¸º callback çš„å‚æ•°</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> x</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                x = callback(value)</span><br><span class="line">            &#125;<span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="comment">// å¼‚å¸¸æ—¶, ç”¨å½“å‰ promise çš„ reject</span></span><br><span class="line">                reject(promise, e)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å¦‚æœ callback è¿”å›çš„æ˜¯å½“å‰çš„ promise</span></span><br><span class="line">            <span class="comment">// è¦æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">if</span> (x === promise) &#123;</span><br><span class="line">                <span class="keyword">let</span> reason = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Error: return value could not be same with the promise'</span>)</span><br><span class="line">                reject(promise, reason)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœè¿”å›å€¼æ˜¯ä¸€ä¸ª promise å¯¹è±¡</span></span><br><span class="line">            <span class="comment">// åˆ™å½“è¿”å› promise å¯¹è±¡è¢« reoslve/ rejectå</span></span><br><span class="line">            <span class="comment">// å†æ‰§è¡Œå½“å‰çš„ promise çš„ resolve/ reject</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (x <span class="keyword">instanceof</span> <span class="built_in">Promise</span>) &#123;</span><br><span class="line">                x.then(</span><br><span class="line">                    <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">                        resolve(promise, data)</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="function"><span class="keyword">function</span> (<span class="params">reason</span>) </span>&#123;</span><br><span class="line">                        reject(promise, reason)</span><br><span class="line">                    &#125;</span><br><span class="line">                )</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> then</span><br><span class="line">                (<span class="function"><span class="keyword">function</span> <span class="title">resolveThenable</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœè¿”å›çš„æ˜¯ä¸€ä¸ª Thenable å¯¹è±¡</span></span><br><span class="line">                    <span class="keyword">if</span> (x &amp;&amp; (<span class="keyword">typeof</span> x === <span class="string">'object'</span> || <span class="keyword">typeof</span> x === <span class="string">'function'</span>)) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            then = x.then</span><br><span class="line">                        &#125;<span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                            reject(promise, e)</span><br><span class="line">                            <span class="keyword">return</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">typeof</span> then === <span class="string">'function'</span>) &#123;</span><br><span class="line">                            <span class="comment">// è°ƒç”¨ Thenable å¯¹è±¡çš„ thenæ–¹æ³•</span></span><br><span class="line">                            <span class="comment">// ä¼ é€’è¿›å»çš„ resolvePromise å’Œ rejectPromise ä»¥åŠä¸‹é¢ä¸¤ä¸ªåŒ¿åå‡½æ•°</span></span><br><span class="line">                            <span class="comment">// å¯èƒ½ä¼šé‡å¤è°ƒç”¨, ä½†æ˜¯è§„èŒƒåªèƒ½æœ‰å…¶ä¸­ä¸€ä¸ªè¢«è°ƒç”¨ä¸€æ¬¡, å…¶ä»–è¦è¢«å¿½ç•¥</span></span><br><span class="line">                            <span class="keyword">let</span> invoked = <span class="literal">false</span></span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                then.call(x,</span><br><span class="line">                                    <span class="function"><span class="keyword">function</span> (<span class="params">y</span>) </span>&#123;</span><br><span class="line">                                        <span class="keyword">if</span> (invoked) <span class="keyword">return</span></span><br><span class="line">                                        invoked = <span class="literal">true</span></span><br><span class="line">                                        </span><br><span class="line">                                        <span class="comment">// é¿å…ä¸¤ä¸ª promise æ’ç­‰</span></span><br><span class="line">                                        <span class="keyword">if</span> (y === x) &#123;</span><br><span class="line">                                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Error: return value could not be same with the promise'</span>)</span><br><span class="line">                                        &#125;</span><br><span class="line">                                        </span><br><span class="line">                                    <span class="comment">// y æœ‰å¯èƒ½è¿˜æ˜¯ thenable å¯¹è±¡    </span></span><br><span class="line">                                    resolveThenable(y)</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">                                        <span class="keyword">if</span> (invoked) <span class="keyword">return</span></span><br><span class="line">                                        invoked = <span class="literal">true</span></span><br><span class="line">                                        </span><br><span class="line">                                        reject(promise, e)</span><br><span class="line">                                    &#125;</span><br><span class="line">                                )</span><br><span class="line">                            &#125;<span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                                    <span class="comment">// å¦‚æœ`resolvePromise`å’Œ`rejectPromise`æ–¹æ³•è¢«è°ƒç”¨åï¼Œå†æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™å¿½ç•¥å¼‚å¸¸</span></span><br><span class="line">                                    <span class="comment">// å¦åˆ™ç”¨å¼‚å¸¸å¯¹è±¡rejectæ­¤Promiseå¯¹è±¡</span></span><br><span class="line">                                <span class="keyword">if</span> (!invoked) &#123;</span><br><span class="line">                                    reject(promise, e)</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                            resolve(promise, x)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                        resolve(promise, x)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;(x))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰ä¼  callbackç›´æ¥ä½¿ç”¨å‰ä¸€ä¸ª promise</span></span><br><span class="line">        <span class="comment">// ä¼ è¿‡æ¥çš„å€¼ resolve/reject å½“å‰ promise å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            action === <span class="string">'resolve'</span></span><br><span class="line">                ? resolve(promise, value)</span><br><span class="line">                : reject(promise, value)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>æˆ‘ä¸€å¼€å§‹æ˜¯å…ˆçœ‹çš„<strong>å‰–æ Promise ä¹‹åŸºç¡€ç¯‡</strong>, å‰åŠéƒ¨åˆ†ç¡®å®å¾ˆäº²æ°‘, ä½†æ˜¯åˆ°åŠ å…¥ <code>hanlde</code> å’Œæ”¹é€  <code>resolve</code> å‡½æ•° å°±å¼€å§‹æ‡µäº†, ç„¶åæ‡µæ‡µæ‡‚æ‡‚çš„å»çœ‹<strong>JS Promise çš„åŸç†å®ç°</strong>, ä¸è¿‡åœ¨æœ€å¤æ‚çš„ <code>makeCallback</code> å‡½æ•°ä¸­è§£é‡Šæœ‰ç‚¹ä¸€ç¬”å¸¦è¿‡çš„æ„æ€. ä¸è¿‡çœ‹äº†è¿™ç¯‡å¸®åŠ©æˆ‘ç†è§£ä¹‹å‰çš„<strong>å‰–æ Promise ä¹‹åŸºç¡€ç¯‡</strong>, å°±è¿”å›å»çœ‹åŸºç¡€ç¯‡ç”»äº†ä¸€éæµç¨‹å›¾æ‰ç®—çœ‹æ‡‚, é‡Œé¢çš„é—­åŒ…ç”¨çš„å¤ªç²¾å¦™äº†.</p>
<blockquote>
<p>å‚è€ƒæ–‡ç« <br><a href="https://tech.meituan.com/promise-insight.html" target="_blank" rel="noopener">å‰–æ Promise ä¹‹åŸºç¡€ç¯‡</a><br><a href="http://bruce-xu.github.io/blogs/js/promise" target="_blank" rel="noopener">JS Promise çš„åŸç†å®ç°</a><br><a href="https://github.com/xieranmaya/blog/issues/3" target="_blank" rel="noopener">å‰–æPromiseå†…éƒ¨ç»“æ„</a></p>
</blockquote>
<p>Created on 2017-12-26 by Cara</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-01-04</span><i class="fa fa-tag"></i><a href="/categories/ç¬”è®°ğŸ“’/" title="ç¬”è®°ğŸ“’" class="tag">ç¬”è®°ğŸ“’ </a><a href="/tags/JavaScript/" title="JavaScript" class="tag">JavaScript </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,https://yoursite.com/2018/01/04/Promise-åˆ†æåŠå®ç°/,Cara's Blog,Promise åˆ†æåŠå®ç°,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2018/04/02/è·¨åŸŸ/" title="è·¨åŸŸ" class="btn">ä¸Šä¸€ç¯‡</a></li><li class="next pagbuttons"><a role="navigation" href="/2018/01/03/HTTP-ä¸Š/" title="ã€Šå›¾è§£ HTTPã€‹(ä¸Š)" class="btn">ä¸‹ä¸€ç¯‡</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>