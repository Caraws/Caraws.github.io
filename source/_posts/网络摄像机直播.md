---
title: 'ç½‘ç»œæ‘„åƒæœºç›´æ’­'
date: 2018-05-06 14:49:04
tags:
- JavaScript
- Node.js
- FFmpeg
categories:
- ç¬”è®°ğŸ“’
---
å¯¹äºç½‘ç»œæ‘„åƒæœºåšè§†é¢‘é¢„è§ˆè¿™å—, æœ¬èº«å…¶å®æ˜¯éå¸¸é™Œç”Ÿçš„, å½“æ—¶æ¥åˆ°è¿™ä¸ªéœ€æ±‚ä¹Ÿæ˜¯ç›¸å½“çš„å¤´ç–¼(å¯¹äºå½“æ—¶ä¸€å¹´ç»éªŒä¸åˆ°çš„æˆ‘æ¥è¯´).å½“æ—¶æˆ‘ä»¬çš„åº”ç”¨åœºæ™¯æ˜¯: å¤šè·¯ç½‘ç»œæ‘„åƒæœºé€šè¿‡å±€åŸŸç½‘è¿æ¥, PC ç«¯èƒ½å¤Ÿå®æ—¶é¢„è§ˆç›‘æ§ç”»é¢å¹¶ä¸”ç”»è´¨è¾¾åˆ°720p, å»¶è¿Ÿä¸èƒ½è¶…è¿‡10ç§’, å¤šä¸ªæ‘„åƒæœºèƒ½å¤Ÿåˆ‡æ¢æŸ¥çœ‹. ç”±äºåç«¯åªæä¾›ä¸€ä¸ª RTSP çš„ç›´æ’­åè®®, æ‰€ä»¥æ‰€æœ‰çš„æ–¹æ¡ˆéƒ½æ˜¯å›´ç»•ç€ RTSP è¿™ä¸ªå…³é”®è¯. å½“æ—¶æ—¶é—´å¾ˆèµ¶æ‰€ä»¥è¦è‡ªå·±æ…¢æ…¢ç ”ç©¶æ˜¯ä¸å¯èƒ½äº†, åªèƒ½å»æ‰¾ç°æˆçš„åº“.

> ç°ç›®å‰ç”¨è¿‡ä¸‰ç§æ–¹æ¡ˆ, éƒ½ä¸å®Œç¾.

### æ•´ä½“æ€è·¯
ç»è¿‡ä¸€æ³¢è°ƒç ”(google)ä¹‹å, çŸ¥é“æµè§ˆå™¨å¯¹ RTSP åè®®å¹¶ä¸å‹å¥½, ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¿…é¡»è¦è‡ªå·±è½¬ç å†æä¾›ç»™æµè§ˆå™¨ä½¿ç”¨, æ‰¾åˆ°çš„è§£å†³æ€è·¯å¤§æ¦‚æ˜¯:

1. è½¬ç : [FFmpeg](https://www.ffmpeg.org/) æ˜¯ä¸€ä¸ªè€ç‰Œçš„è½¬ç å·¥å…·, éå¸¸å¼ºå¤§
2. Node.js ç”¨ä½œä¸­è½¬ç«™æ¥æ”¶å®¢æˆ·ç«¯å‘æ¥çš„æ‘„åƒæœºä¿¡æ¯åŠæ§åˆ¶ FFmpeg æ¨æµ
3. æœ€ç»ˆå®¢æˆ·ç«¯æ¥æ”¶è§†é¢‘æµ

ä¸‹é¢æˆ‘è¯•è¿‡çš„ä¸‰ç§æ–¹æ¡ˆ, åŸºæœ¬ç»“æ„éƒ½å¦‚æ­¤åªæ˜¯æ¨æµçš„æ–¹å¼å’Œå®¢æˆ·ç«¯çš„æ¥æ”¶æ–¹å¼æœ‰æ‰€ä¸åŒ.

### å‡†å¤‡

**å®‰è£… FFmpeg è½¬ç å·¥å…·**

- window å¹³å°

1. [ä¸‹è½½ FFmpeg](http://ffmpeg.zeranoe.com/builds/) è§£å‹ååº”è¯¥æ˜¯å·²ç»ç¼–è¯‘å¥½çš„æ–‡ä»¶
2. å°†è§£å‹å¥½çš„æ–‡ä»¶æ”¾å…¥ C ç›˜æ ¹ç›®å½•(ä¹Ÿå¯ä»¥è‡ªè¡Œæ”¾å…¥å…¶ä»–ç›˜ç¬¦)ä¸‹é‡å‘½åä¸º ffmpeg(æ–¹ä¾¿ä»¥åæ‰¾)
3. è®¾ç½®ç¯å¢ƒå˜é‡, æˆ‘çš„ç”µè„‘ -> å±æ€§ -> é«˜çº§ç³»ç»Ÿè®¾ç½® -> ç¯å¢ƒå˜é‡ -> ç³»ç»Ÿå˜é‡ -> æ–°å¢, è·¯å¾„é€‰æ‹©åˆšåˆš C ç›˜ä¸‹çš„ ffmpegæ–‡ä»¶å¤¹ä¸­çš„ bin æ–‡ä»¶å¤¹
4. æ³¨é”€æˆ–é‡å¯ç”µè„‘è®©ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ
5. æµ‹è¯•, åœ¨ cmd ä¸­è¾“å…¥ `ffmpeg -version`,  å¦‚æœå‡ºç°ç‰ˆæœ¬å·ä¹‹ç±»çš„ä¸œè¥¿åˆ™æˆåŠŸ.

- Mac å¹³å°
Mac ä¸‹å¯ä»¥ç›´æ¥é€šè¿‡ `Homebrew` å®‰è£…æœ€ä¸ºç®€å•.

1. å®‰è£… `Homebrew`, åœ¨ç»ˆç«¯ä¸­è¾“å…¥ `ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"`
2. å®‰è£… FFmpeg, ç›´æ¥åœ¨ç»ˆç«¯ä¸­è¾“å…¥ `brew install ffmpeg` å³å¯
3. æµ‹è¯•, åŒæ ·åœ¨ç»ˆç«¯ä¸­è¾“å…¥ `ffmpeg -version` æŸ¥çœ‹ç‰ˆæœ¬å·

**å®‰è£… Node.js**
è¿™ä¸ªå°±ä¸å±•å¼€è¯¦ç»†è¯´äº†, æ¯ä¸ªå‰ç«¯éƒ½æœ‰å§...

### æ–¹æ¡ˆä¸€: img æ ‡ç­¾
å½“æ—¶æƒ³åˆ°çš„ç¬¬ä¸€ç§æ–¹æ¡ˆä¹Ÿæ˜¯æœ€ç®€å•çš„æ–¹æ¡ˆ, æ˜¯å°†è§†é¢‘æµçš„æ¯ä¸€å¸§è½¬åŒ–ä¸º base64 å†é€šè¿‡åŠ¨æ€æ›¿æ¢ `<img>` çš„ src å±æ€§æ¥è¾¾åˆ°é¢„è§ˆçš„æ•ˆæœ.ä¸­é—´ç”¨åˆ°äº†[rtsp-ffmpeg](https://github.com/agsh/rtsp-ffmpeg), è¿™ä¸ªåº“çš„æ€è·¯æ˜¯é€šè¿‡ websocket å‘é€æ¯ä¸€å¸§è§†é¢‘çš„ bytes åˆ°å®¢æˆ·ç«¯, å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ `<img>` æ ‡ç­¾æ¥å±•ç¤º.

ç¤ºä¾‹: 

node ç«¯
```js
const app = require('express')()
const server = require('http').Server(app)
const io = require('socket.io')(server)
const rtsp = require('rtsp-ffmpeg')

server.listen(8081, () => {
    console.log('server listening on 8081')
})

// uri ä»¥æµ·åº·æ‘„åƒæœºçš„ rtsp åè®®ä¸ºä¾‹
let uri = 'rtps://admin:password@ip:port/h264/ch1/sub/av_stream'
let stream = new rtsp.FFMpeg({
    input: uri,
    resolution: '1080x720',
    quality: 3
})

stream.on('start', function () {
    console.log('stream')
})

stream.on('stop', function () {
    console.log('stream stopped')
})

io.on('connection', socket => {
    const pipeStream = data => {
        socket.emit('data', data)
    }
    stream.on('data', pipeStream)

    // åˆ‡æ¢æ‘„åƒæœº
    socket.on('URI', data => {
        console.log(data)
        uri = `rtsp://${data.userName}:${data.passWord}@${data.ip}:${data.port}/h264/ch1/sub/av_stream`
        stream.input = uri

        // é‡å¯
        stream.restart()
    })

    socket.on('disconnect' () => {
        stream.removeListener('data', pipeStream)
    })
})
```

å®¢æˆ·ç«¯
```html
<body>
    <img id='img'>
<script src='/socket.io/socket.io.js'></script>
<script>
	var io = io();
    let img = document.querySelector('#img')
	io.on('data', function(data) {
        let bytes = new Unit8Array(data)
        img.src = 'data:image/jpeg;base64,' + base64ArrayBuffer(bytes)
			
	})
    // byte æ•°ç»„è½¬ base64 (è¿™æ®µæ˜¯åœ¨å…¶ä»–åœ°æ–¹æŠ„çš„)
	function base64ArrayBuffer(arrayBuffer) {
		var base64    = '';
		var encodings = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
		var bytes         = new Uint8Array(arrayBuffer);
		var byteLength    = bytes.byteLength;
		var byteRemainder = byteLength % 3;
		var mainLength    = byteLength - byteRemainder;
		var a, b, c, d;
		var chunk;
		// Main loop deals with bytes in chunks of 3
		for (var i = 0; i < mainLength; i = i + 3) {
			// Combine the three bytes into a single integer
			chunk = (bytes[i] << 16) | (bytes[i + 1] << 8) | bytes[i + 2];
			// Use bitmasks to extract 6-bit segments from the triplet
			a = (chunk & 16515072) >> 18; // 16515072 = (2^6 - 1) << 18
			b = (chunk & 258048)   >> 12; // 258048   = (2^6 - 1) << 12
			c = (chunk & 4032)     >>  6; // 4032     = (2^6 - 1) << 6
			d = chunk & 63;               // 63       = 2^6 - 1
			// Convert the raw binary segments to the appropriate ASCII encoding
			base64 += encodings[a] + encodings[b] + encodings[c] + encodings[d];
		}
		// Deal with the remaining bytes and padding
		if (byteRemainder == 1) {
			chunk = bytes[mainLength];
			a = (chunk & 252) >> 2; // 252 = (2^6 - 1) << 2
			// Set the 4 least significant bits to zero
			b = (chunk & 3)   << 4; // 3   = 2^2 - 1
			base64 += encodings[a] + encodings[b] + '==';
		} else if (byteRemainder == 2) {
			chunk = (bytes[mainLength] << 8) | bytes[mainLength + 1];
			a = (chunk & 64512) >> 10; // 64512 = (2^6 - 1) << 10
			b = (chunk & 1008)  >>  4; // 1008  = (2^6 - 1) << 4
			// Set the 2 least significant bits to zero
			c = (chunk & 15)    <<  2; // 15    = 2^4 - 1
			base64 += encodings[a] + encodings[b] + encodings[c] + '=';
		}
		return base64;
	}
</script>
</body>
```

è¿™ç§é€šè¿‡ img çš„æ–¹å¼æš´éœ²å‡ºçš„é—®é¢˜æ˜¯éœ€è¦åœ¨å‰ç«¯è§£ç , å¯¼è‡´ä¸‹ä¸€å¸§åˆ°æ¥æ—¶ä¸Šä¸€å¸§çš„ç”»é¢è¿˜æ²¡è§£ç å®Œæˆ. å°±ä¼šæœ‰èŠ±å±ç”šè‡³ç”»é¢åªæ˜¾ç¤ºä¸€åŠçš„é—®é¢˜å’Œå»¶è¿Ÿè¾ƒå¤§ä¸”å»¶è¿Ÿä¼šç´¯ç§¯, åœ¨æ§åˆ¶å°ä¸­ä½ ä¼šçœ‹åˆ°ç–¯ç‹‚åˆ·ä»å†…å­˜æ¥çš„è¯·æ±‚, å¦‚æœä½ æƒ³çœ‹çœ‹ http è¯·æ±‚å¯èƒ½ä¼šç–¯. æ‰€ä»¥è¿™ç§æ–¹å¼è‚¯å®šä¸è¡Œ

è¿™ä¸ª `rtsp-ffmpeg` è¿˜æä¾›ä¸€ç§ canvas çš„æ–¹å¼, åªæ˜¯åœ¨å®¢æˆ·ç«¯åšä¸€äº›ä¿®æ”¹:
```js
var io = io();
// æŠŠä¹‹å‰çš„ img æ ‡ç­¾æ¢æˆ canvas
let canvas = document.querySelector('#canvas')
io.on('data', data => {
    var bytes = new Uint8Array(data)
					
    var blob = new Blob([bytes], {type: 'application/octet-binary'})
                    
    var url = URL.createObjectURL(blob)
                    
    var img = new Image
                    
    var ctx = canvas.getContext("2d")
        img.width = img.width * 0.5
        img.height = img.height * 0.5
        img.onload = function() {
            URL.revokeObjectURL(url)
            ctx.drawImage(img, 0, 0, 1080, 720)
        };    
    img.src = url
})
```

ç”¨ canvas çš„æ–¹æ³•è™½ç„¶æ¯” img çš„æ•ˆæœå¥½ä¸€ç‚¹, ä½†æ˜¯æœ€ç»ˆæ•ˆæœä»ç„¶æ˜¯ä¸å°½äººæ„. å›¾åƒå¾ˆä¸ç¨³å®š, è¡¨ç°ä¸ºä¸€åŠç”»é¢ä¸€åŠç»¿å±, å¦‚æœè§†é¢‘ä¸­å›¾åƒå˜æ¢å‰§çƒˆçš„è¯è¡¨ç°ä¼šæ›´å·®, æ‰€ä»¥è¿™ç§æ–¹æ³•ä¹Ÿä¸å¤ªè¡Œ. å…¶å®åœ¨è¿™ä¸­é—´æˆ‘å¹¶æ²¡æœ‰åšä»€ä¹ˆæ“ä½œåªæ˜¯å°†è¿™ä¸ª demo é›†æˆåœ¨äº† vue ä¸­, å†åŠ ä¸Šå¤šæ‘„åƒæœºçš„åˆ‡æ¢å’Œä¸»æµæ‘„åƒæœºå‚å•†çš„æ”¯æŒ(å› ä¸ºæ¯ä¸ªæ‘„åƒæœºå‚å•†çš„ rtsp åè®®çš„ç»“æ„ä¸ä¸€æ ·)è€Œå·², æ‰€ä»¥ç¬¬ä¸€æƒ³æ³•æ˜¯èƒ½ä¸èƒ½åœ¨è§£ç è¿™å—æ‰¾åˆ°æ›´å¥½è§£å†³åŠæ³•, äºæ˜¯åˆæ‰¾åˆ°äº†å¦ä¸€ä¸ªåº“ [jsmpeg](https://github.com/phoboslab/jsmpeg) æ–¹æ¡ˆäºŒå°±æ¥äº†.


### æ–¹æ¡ˆäºŒ: jsmpeg
è¿™ä¸ªåº“è¿˜ç®—æ¯”è¾ƒä¸é”™çš„äº†, ä¹Ÿæ˜¯é€šè¿‡ websocket æ¥è½¬å‘, çœ‹å®˜æ–¹çš„ä¾‹å­æ˜¯åœ¨ç»ˆç«¯ä¸­å¯åŠ¨ ffmpeg -> websocket -> å®¢æˆ·ç«¯é€šè¿‡ `jsmpeg.min.js` è§£ç åœ¨ canvas ä¸­æ’­æ”¾. å› ä¸ºè¿™é‡Œåªæ˜¯å®ç°äº†æ’­æ”¾, åœ¨è¿™ä¸ªåŸºç¡€ä¸Šæˆ‘ä»¬è¿˜éœ€è¦åœ¨è„šæœ¬ä¸­è‡ªå¯ ffmpeg / åˆ‡æ¢/ é‡å¯, ç„¶ååˆå»æ‰¾äº†ä¸€ä¸ªåŸºäº `jsmpeg` çš„åº“ [node-rtsp-stream](https://github.com/kyriesent/node-rtsp-stream). è¿™ä¸ªåº“åªæ˜¯åšäº†ä¸€äº›å°è£…è®©æˆ‘ä»¬ä¸ç”¨è‡ªå·±åœ¨ç»ˆç«¯ä¸­æ‰‹åŠ¨å¯ç”¨ ffmpeg, åœ¨æ­¤ä¹‹ä¸Šæˆ‘å†åŠ ä¸Šé‡å¯å°±èƒ½æ»¡è¶³ç°åœ¨çš„éœ€æ±‚.

ç¤ºä¾‹:

1. æ”¹é€  `node-rtsp-stream`

node-rtsp-stream/videoStream.js
```js
(function() {
    var Mpeg1Muxer, STREAM_MAGIC_BYTES, VideoStream, events, util, ws;

    ws = require('ws');

    util = require('util');

    events = require('events');

    Mpeg1Muxer = require('./mpeg1muxer');

    STREAM_MAGIC_BYTES = "jsmp";

    var child_process = require('child_process');

    VideoStream = function(options) {
        this.name = options.name;
        this.streamUrl = options.streamUrl;
        this.width = options.width;
        this.height = options.height;
        this.wsPort = options.wsPort;
        this.inputStreamStarted = false;
        this.stream = void 0;
        this.startMpeg1Stream();
        this.pipeStreamToSocketServer();
        return this;
    };

    util.inherits(VideoStream, events.EventEmitter);
    // åœæ­¢è§†é¢‘æµ
    VideoStream.prototype.stop = function () {
        if (this.mpeg1Muxer) {
            this.mpeg1Muxer.stream.stop()
        }
    }
    // é‡å¯è§†é¢‘æµ
    VideoStream.prototype.restart = function() {
        if (this.mpeg1Muxer) {
            this.mpeg1Muxer.stream.stop()
            console.log('ffmpeg is restart')
            this.inputStreamStarted = false;
            this.stream = void 0;
            this.startMpeg1Stream();
            // ç›‘å¬ ffmpeg è¿›ç¨‹æ˜¯å¦å…³é—­
            this.mpeg1Muxer.on('ffmpegClose', function(code) {
                console.log('ffmpeg closed on ' + code)
            })
        }
    }

    VideoStream.prototype.startMpeg1Stream = function() {
        // çœç•¥æ‰“å¼€æµçš„æ–¹æ³•, è¿™éƒ¨åˆ†æ²¡æœ‰åšæ”¹åŠ¨
    };

    VideoStream.prototype.pipeStreamToSocketServer = function() {
        // å°†æµå¡ç»™ socket, åŒæ ·ä¹Ÿæ²¡æ”¹
    };

    VideoStream.prototype.onSocketConnect = function(socket) {
        var self, streamHeader;
        self = this;
        streamHeader = new Buffer(8);
        streamHeader.write(STREAM_MAGIC_BYTES);
        streamHeader.writeUInt16BE(this.width, 4);
        streamHeader.writeUInt16BE(this.height, 6);
        socket.send(streamHeader, {
            binary: true
        });
        console.log(("" + this.name + ": New WebSocket Connection (") + this.wsServer.clients.length + " total)");
        return socket.on("close", function(code, message) {
            return console.log(("" + this.name + ": Disconnected WebSocket (") + self.wsServer.clients.length + " total)");
        });
    };

    module.exports = VideoStream;

}).call(this);
```

node-rtsp-stream/videoStream.js
```js
(function() {
    var Mpeg1Muxer, child_process, events, util;

    child_process = require('child_process');

    util = require('util');

    events = require('events');

    Mpeg1Muxer = function(options) {
        var self;
        self = this;
        this.url = options.url;
        this.stream = child_process.spawn("ffmpeg", 
            [
                "-rtsp_transport",
                "tcp",
                "-i",
                this.url,
                '-s', 
                // å›¾åƒå®½é«˜
                `${options.width}x${options.height}`, 
                '-f', 
                'mpeg1video', 
                '-b:v', 
                '800k', 
                '-r', 
                '30', 
                '-'
            ], 
            {
                detached: false
            }
        );
        this.inputStreamStarted = true;
        this.stream.stdout.on('data', function(data) {
            return self.emit('mpeg1data', data);
        });
        this.stream.stderr.on('data', function(data) {
            return self.emit('ffmpegError', data);
        });
        // kill ffmpeg
        this.stream.stop = function() {
            // console.log(self.stream.pid)
            self.stream.stdin.pause();
            self.stream.kill()
            console.log('ffmpeg is be kill')
        };
        // ç›‘å¬ ffmpeg é€€å‡º
        this.stream.on('exit', function(code) {
            return self.emit('ffmpegClose', code)
        })
        return this;
    };

    util.inherits(Mpeg1Muxer, events.EventEmitter);

    module.exports = Mpeg1Muxer;

}).call(this);
```

2. node ç«¯ä½¿ç”¨

```js
const app = require('express')()
const server = require('http').Server(app)
const io = require('socket.io')(server)
// å¼•å…¥æ”¹é€ åçš„ node-rtsp-stream
const Rtsp = require('./node-rtsp-stream')

server.listen(8081, () => {
    console.log('server listening on 8081')
})

// uri ä»¥æµ·åº·æ‘„åƒæœºçš„ rtsp åè®®ä¸ºä¾‹
let uri = 'rtps://admin:password@ip:port/h264/ch1/sub/av_stream'
let stream = new Rtsp({
    name: 'rtsp_stream',
    streamUrl: uri,
    wsPort: 11111,
    width: 720,
    height: 405
})

stream.on('start', function () {
    console.log('stream')
})

stream.on('stop', function () {
    console.log('stream stopped')
})

io.on('connection', socket => {
    const pipeStream = data => {
        socket.emit('data', data)
    }
    stream.on('data', pipeStream)

    // åˆ‡æ¢æ‘„åƒæœº
    socket.on('URI', data => {
        console.log(data)
        uri = `rtsp://${data.userName}:${data.passWord}@${data.ip}:${data.port}/h264/ch1/sub/av_stream`
        stream.streamUrl = uri;
        // é‡å¯
        stream.restart()
    })

    socket.on('disconnect' () => {
        stream.removeListener('data', pipeStream)
    })
})
```

3. å®¢æˆ·ç«¯

```html
<canvas id='can'></canvas>
<script src='jsmpeg.min.js'></script>
<script>
    let canvas = document.querySelector('#can')
    let ws = new WebSocket('ws://127.0.0.1:11111')
    let player = new jsmpeg(ws, {
        canvas: canvas,
        autoplay: true
    })
</script>
```

è¿™ä¸ªæ–¹æ¡ˆå…¶å®ä½¿ç”¨äº†å¾ˆä¹…ä¸€ç›´éƒ½æ²¡å‘ç°é—®é¢˜, æ˜¯åœ¨ä¸€è·¯æ‘„åƒæœºå®‰ç½®åœ¨å¤©æ¡¥é™„è¿‘äººæµé‡å‰§å¢, ä¸è¿™ä¸ªè§†é¢‘é¢„è§ˆåŒä¸€é¡µé¢è¿˜æœ‰ä¸€ä¸ªäººè„¸å®æ—¶æŠ“æ‹çš„å³æ—¶æ¶ˆæ¯æ¨é€çš„åŠŸèƒ½, å¯¼è‡´åœ¨20 - 30åˆ†é’Ÿæµè§ˆå™¨ç›´æ¥å‡æ­»æˆ–è€…å´©æºƒ.(ç„¶åè¿™ä¸ªæ–¹æ¡ˆåˆå‡‰äº†ğŸ˜‚)

### æ–¹æ¡ˆä¸‰: FFmpeg + Nginx + video.js
æ–¹æ¡ˆä¸‰ä¸‹æ¬¡å†™~



Created on 2017/7/26 by Cara
