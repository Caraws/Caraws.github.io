---
title: 'ç½‘ç»œæ‘„åƒæœºç›´æ’­'
date: 2017-10-15 18:49:04
tags:
- JavaScript
- Node.js
- FFmpeg
categories:
- ç¬”è®°ğŸ“’
---
å¯¹äºç½‘ç»œæ‘„åƒæœºåšè§†é¢‘é¢„è§ˆè¿™å—, æœ¬èº«å…¶å®æ˜¯éå¸¸é™Œç”Ÿçš„, å½“æ—¶æ¥åˆ°è¿™ä¸ªéœ€æ±‚ä¹Ÿæ˜¯ç›¸å½“çš„å¤´ç–¼(å¯¹äºå½“æ—¶ä¸€å¹´ç»éªŒä¸åˆ°çš„æˆ‘æ¥è¯´).å½“æ—¶æˆ‘ä»¬çš„åº”ç”¨åœºæ™¯æ˜¯: å¤šè·¯ç½‘ç»œæ‘„åƒæœºé€šè¿‡å±€åŸŸç½‘è¿æ¥, PC ç«¯èƒ½å¤Ÿå®æ—¶é¢„è§ˆç›‘æ§ç”»é¢å¹¶ä¸”ç”»è´¨è¾¾åˆ°720p, å»¶è¿Ÿä¸èƒ½è¶…è¿‡10ç§’, å¤šä¸ªæ‘„åƒæœºèƒ½å¤Ÿåˆ‡æ¢æŸ¥çœ‹. ç”±äºåç«¯åªæä¾›ä¸€ä¸ª RTSP çš„ç›´æ’­åè®®, æ‰€ä»¥æ‰€æœ‰çš„æ–¹æ¡ˆéƒ½æ˜¯å›´ç»•ç€ RTSP è¿™ä¸ªå…³é”®è¯.

> ç°ç›®å‰ç”¨è¿‡ä¸‰ç§æ–¹æ¡ˆ, éƒ½ä¸å®Œç¾.

### æ•´ä½“æ¶æ„
ç»è¿‡ä¸€æ³¢è°ƒç ”ä¹‹å, çŸ¥é“æµè§ˆå™¨å¯¹ RTSP åè®®å¹¶ä¸å‹å¥½, ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¿…é¡»è¦è‡ªå·±è½¬ç å†æä¾›ç»™æµè§ˆå™¨ä½¿ç”¨, æ‰¾åˆ°çš„è§£å†³æ€è·¯å¤§æ¦‚æ˜¯:

1. è½¬ç : [FFmpeg](https://www.ffmpeg.org/) æ˜¯ä¸€ä¸ªè€ç‰Œçš„è½¬ç å·¥å…·, éå¸¸å¼ºå¤§
2. Node.js ç”¨ä½œä¸­è½¬ç«™æ¥æ”¶å®¢æˆ·ç«¯å‘æ¥çš„æ‘„åƒæœºä¿¡æ¯åŠæ§åˆ¶ FFmpeg æ¨æµ
3. å°† FFmpeg çš„æµæ¨é€åˆ° [Nginx](https://nginx.org/en/)

### æ–¹æ¡ˆä¸€: img æ ‡ç­¾
å½“æ—¶æƒ³åˆ°çš„ç¬¬ä¸€ç§æ–¹æ¡ˆä¹Ÿæ˜¯æœ€ç®€å•çš„æ–¹æ¡ˆ, æ˜¯å°†è§†é¢‘æµçš„æ¯ä¸€å¸§è½¬åŒ–ä¸º base64 å†é€šè¿‡åŠ¨æ€æ›¿æ¢ `<img>` çš„ src å±æ€§æ¥è¾¾åˆ°é¢„è§ˆçš„æ•ˆæœ






åœ¨é¢„è§ˆæ‘„åƒå¤´ç›‘æ§ç”»é¢æ—¶, ç”¨ `WebSocket` å‘é€ RTSP å®æ—¶è§†é¢‘æµ. åœ¨æµè§ˆå™¨ä¸­æ¥æ”¶åˆ°æ˜¯ä¸€å † bytes, æ‰€ä»¥éœ€è¦è½¬åŒ–ä¸º blob ç±»å‹æˆ–è€… base64 ç»™canvas æ¸²æŸ“å‡ºæ¥.

> ### 1. Nodeç«¯
å½“æ—¶ç”¨çš„æ˜¯ä¸€ä¸ªä¸ªäººé¡¹ç›®`rtsp-ffmpeg` [é“¾æ¥](https://github.com/agsh/rtsp-ffmpeg), æœ‰ç©ºçš„è¯å¯ä»¥çœ‹çœ‹`WebRTC`

- å®‰è£…FFMPEG [FFMPEGä¸‹è½½](http://ffmpeg.zeranoe.com/builds/)
- è§£å‹å, åœ¨Cç›˜æ ¹ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶å¤¹ffmpeg, å°†è§£å‹æ–‡ä»¶æ”¾å…¥
- è®¾ç½®ç¯å¢ƒå˜é‡, windowsä¸‹åœ¨æˆ‘çš„ç”µè„‘ -> å±æ€§ -> é«˜çº§ç³»ç»Ÿè®¾ç½® -> ç¯å¢ƒå˜é‡ -> ç³»ç»Ÿå˜é‡ -> æ–°å¢
åœ¨åˆšåˆšffmpegçš„è·¯å¾„ä¸Šå…·ä½“åˆ°æ–‡ä»¶å¤¹ä¸­çš„binæ–‡ä»¶å¤¹
- æµ‹è¯•, åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥`ffmpeg -version` å‡ºç°ç‰ˆæœ¬å·å•¥çš„å°±å®‰è£…æˆåŠŸ (å¦‚æœä¸è¡Œçš„è¯, æ³¨é”€ç”µè„‘è®©ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ)

> ### 2. åˆ©ç”¨`socket.io`å‘æµè§ˆå™¨å‘é€è§†é¢‘æ•°æ®
å…³é”®ä»£ç : 
```javascript
 var rtsp = require('rtsp-ffmpeg');
 // æ¨æµ
 var uri = 'rtsp://accout:password@ip:port/h264/ch1/main/av_stream',
     stream = new rtsp.FFMpeg({
         input: uri,
         rate: 10,
         resolution: '320x240',
         quality: 3
     });

 var cameraInfo = {}
 // è¿æ¥æ—¶
 io.on('connection', socket => {
     console.log('connection')
     var pipeStream = function(data) {
         socket.emit('data', data);
     };
     stream.on('data', pipeStream);
     socket.on('URI', data => {
         console.log(data);
         cameraInfo.cameraName = data.cameraName;
         cameraInfo.groupName = data.groupName;
         uri = `rtsp://${data.userName}:${data.passWord}@${data.ip}:${data.RTSP}/h264/ch1/main/av_stream`;
         stream.input = uri;
         stream.restart();
         socket.emit('CameraInfo', cameraInfo);
     })
     // æ–­å¼€è¿æ¥
     socket.on('disconnect', function() {
         stream.removeListener('data', pipeStream);
     });
 })
```

ä¸­é—´å°†`Node.js`æ‰˜ç®¡åˆ°IISæœåŠ¡å™¨ä¸Šæ—¶ä¼šå‡ºç°è·¨åŸŸçš„æŠ¥é”™, å¯èƒ½æ˜¯å’Œåç«¯è¿æ¥æ—¶ç«¯å£è¢«å , å…·ä½“çœ‹IISæŠ¥ä»€ä¹ˆé”™. å¦‚æœIISæ²¡æŠ¥é”™, è¿˜æ˜¯æœ‰è·¨åŸŸçš„è¯å¯èƒ½è¿˜æ˜¯`ffmpeg`æ²¡å®‰è£…ä¸Š.

å¦‚æœç”¨canvasé¢„è§ˆæ‘„åƒå¤´è¿˜æ˜¯æœ‰èŠ±å±çš„æƒ…å†µ, å¯ä»¥å°†ç æµåˆ‡æ¢ä¸ºå­ç æµ`rtsp://accout:password@ip:port/h264/ch1/sub/av_stream`

> ### 3. æµè§ˆå™¨
åŸºäº`Vue.js`, å…ˆå¼•å…¥`socket.io`å¹¶å»ºç«‹è¿æ¥, ç„¶åå¯¹è§†é¢‘æµæ•°æ®åšå¤„ç†(å±•ç¤ºæ—¶ä¸è¦ç”¨`img`æ ‡ç­¾, æ‰å¸§æ¯”è¾ƒä¸¥é‡).

å…³é”®ä»£ç : 
```JavaScript
var bytes = new Uint8Array(data);
					
var blob = new Blob([bytes], {type: 'application/octet-binary'});
                
var url = URL.createObjectURL(blob);
                
var img = new Image;
                
var ctx = this.canvas.getContext("2d");
    img.width = img.width * 0.5;
    img.height = img.height * 0.5;
    img.onload = function() {
         URL.revokeObjectURL(url);
         ctx.drawImage(img, 0, 0,720,560);
    };    
img.src = url;
```

Created on 2017/7/26 by Cara
