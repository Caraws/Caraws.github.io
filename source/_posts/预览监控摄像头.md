---
title: ' é¢„è§ˆç›‘æ§æ‘„åƒå¤´'
date: 2017-10-15 18:49:04
tags:
- JavaScript
- Node.js
categories:
- ç¬”è®°ğŸ“’
---

> ç°ç›®å‰ç”¨è¿‡ä¸‰ç§æ–¹æ¡ˆ, éƒ½ä¸å®Œç¾. ä»¥ä¸‹è¯´çš„æ˜¯å¾ˆæ—©ä¹‹å‰çš„æ–¹æ¡ˆ, ä¹‹åæœ‰ç©ºå†é‡æ–°å†™è¿™ç¯‡.



åœ¨é¢„è§ˆæ‘„åƒå¤´ç›‘æ§ç”»é¢æ—¶, ç”¨ `WebSocket` å‘é€ RTSP å®æ—¶è§†é¢‘æµ. åœ¨æµè§ˆå™¨ä¸­æ¥æ”¶åˆ°æ˜¯ä¸€å † bytes, æ‰€ä»¥éœ€è¦è½¬åŒ–ä¸º blob ç±»å‹æˆ–è€… base64 ç»™canvas æ¸²æŸ“å‡ºæ¥.

> ### 1. Nodeç«¯
å½“æ—¶ç”¨çš„æ˜¯ä¸€ä¸ªä¸ªäººé¡¹ç›®`rtsp-ffmpeg` [é“¾æ¥](https://github.com/agsh/rtsp-ffmpeg), æœ‰ç©ºçš„è¯å¯ä»¥çœ‹çœ‹`WebRTC`

- å®‰è£…FFMPEG [FFMPEGä¸‹è½½](http://ffmpeg.zeranoe.com/builds/)
- è§£å‹å, åœ¨Cç›˜æ ¹ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶å¤¹ffmpeg, å°†è§£å‹æ–‡ä»¶æ”¾å…¥
- è®¾ç½®ç¯å¢ƒå˜é‡, windowsä¸‹åœ¨æˆ‘çš„ç”µè„‘ -> å±æ€§ -> é«˜çº§ç³»ç»Ÿè®¾ç½® -> ç¯å¢ƒå˜é‡ -> ç³»ç»Ÿå˜é‡ -> æ–°å¢
åœ¨åˆšåˆšffmpegçš„è·¯å¾„ä¸Šå…·ä½“åˆ°æ–‡ä»¶å¤¹ä¸­çš„binæ–‡ä»¶å¤¹
- æµ‹è¯•, åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥`ffmpeg -version` å‡ºç°ç‰ˆæœ¬å·å•¥çš„å°±å®‰è£…æˆåŠŸ (å¦‚æœä¸è¡Œçš„è¯, æ³¨é”€ç”µè„‘è®©ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ)

> ### 2. åˆ©ç”¨`socket.io`å‘æµè§ˆå™¨å‘é€è§†é¢‘æ•°æ®
å…³é”®ä»£ç : 
```javascript
 var rtsp = require('rtsp-ffmpeg');
 // æ¨æµ
 var uri = 'rtsp://accout:password@ip:port/h264/ch1/main/av_stream',
     stream = new rtsp.FFMpeg({
         input: uri,
         rate: 10,
         resolution: '320x240',
         quality: 3
     });

 var cameraInfo = {}
 // è¿æ¥æ—¶
 io.on('connection', socket => {
     console.log('connection')
     var pipeStream = function(data) {
         socket.emit('data', data);
     };
     stream.on('data', pipeStream);
     socket.on('URI', data => {
         console.log(data);
         cameraInfo.cameraName = data.cameraName;
         cameraInfo.groupName = data.groupName;
         uri = `rtsp://${data.userName}:${data.passWord}@${data.ip}:${data.RTSP}/h264/ch1/main/av_stream`;
         stream.input = uri;
         stream.restart();
         socket.emit('CameraInfo', cameraInfo);
     })
     // æ–­å¼€è¿æ¥
     socket.on('disconnect', function() {
         stream.removeListener('data', pipeStream);
     });
 })
```

ä¸­é—´å°†`Node.js`æ‰˜ç®¡åˆ°IISæœåŠ¡å™¨ä¸Šæ—¶ä¼šå‡ºç°è·¨åŸŸçš„æŠ¥é”™, å¯èƒ½æ˜¯å’Œåç«¯è¿æ¥æ—¶ç«¯å£è¢«å , å…·ä½“çœ‹IISæŠ¥ä»€ä¹ˆé”™. å¦‚æœIISæ²¡æŠ¥é”™, è¿˜æ˜¯æœ‰è·¨åŸŸçš„è¯å¯èƒ½è¿˜æ˜¯`ffmpeg`æ²¡å®‰è£…ä¸Š.

å¦‚æœç”¨canvasé¢„è§ˆæ‘„åƒå¤´è¿˜æ˜¯æœ‰èŠ±å±çš„æƒ…å†µ, å¯ä»¥å°†ç æµåˆ‡æ¢ä¸ºå­ç æµ`rtsp://accout:password@ip:port/h264/ch1/sub/av_stream`

> ### 3. æµè§ˆå™¨
åŸºäº`Vue.js`, å…ˆå¼•å…¥`socket.io`å¹¶å»ºç«‹è¿æ¥, ç„¶åå¯¹è§†é¢‘æµæ•°æ®åšå¤„ç†(å±•ç¤ºæ—¶ä¸è¦ç”¨`img`æ ‡ç­¾, æ‰å¸§æ¯”è¾ƒä¸¥é‡).

å…³é”®ä»£ç : 
```JavaScript
var bytes = new Uint8Array(data);
					
var blob = new Blob([bytes], {type: 'application/octet-binary'});
                
var url = URL.createObjectURL(blob);
                
var img = new Image;
                
var ctx = this.canvas.getContext("2d");
    img.width = img.width * 0.5;
    img.height = img.height * 0.5;
    img.onload = function() {
         URL.revokeObjectURL(url);
         ctx.drawImage(img, 0, 0,720,560);
    };    
img.src = url;
```

Created on 2017/7/26 by Cara
